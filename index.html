<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ixka</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 90vw;
            margin: auto;
        }
        .download-button, .play-button {
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .download-button:hover, .play-button:hover {
            transform: translateY(-2px);
        }
        .spinner {
            border-top-color: #3498db;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Styles for the new modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-8">

    <div class="container bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl space-y-8">

        <!-- Search Section -->
        <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchKey" placeholder="Enter search key..." class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200 placeholder-gray-500">
                <button id="fetchBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 download-button">
                    Search Music
                </button>
            </div>
        </div>

        <!-- Status & Loading -->
        <div id="statusMessage" class="text-center font-medium"></div>
        <div id="loadingIndicator" class="hidden flex justify-center items-center">
            <div class="spinner w-8 h-8 rounded-full border-4 border-gray-600"></div>
        </div>
        
        <!-- Music List Section -->
        <div id="musicListContainer" class="hidden overflow-x-auto">
            <!-- Global Quality Selector & Delay Section -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="globalQualitySelect" class="block text-sm font-medium text-gray-300">Set Quality for All:</label>
                    <div class="flex gap-2">
                        <select id="globalQualitySelect" class="bg-gray-700 border border-gray-600 rounded-xl p-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <button id="applyQualityBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Apply to All</button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2 mt-4 sm:mt-0">
                    <label for="downloadDelay" class="block text-sm font-medium text-gray-300">Download Delay (seconds):</label>
                    <input type="number" id="downloadDelay" value="1" min="0" class="w-20 p-2 bg-gray-700 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200">
                </div>
            </div>

            <div class="flex justify-end gap-2 mb-6">
                <button id="selectAllBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Select All</button>
                <button id="clearSelectionsBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Clear Selections</button>
                <button id="downloadAllBtn" class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 download-button">Download Selected</button>
            </div>

            <table class="min-w-full divide-y divide-gray-700 rounded-xl overflow-hidden shadow-lg">
                <thead class="bg-gray-700">
                    <tr>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">
                            <input type="checkbox" id="masterCheckbox" class="rounded text-blue-600 focus:ring-blue-500">
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Title</th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider hidden sm:table-cell">Artist</th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider hidden sm:table-cell">Album</th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Quality</th>
                        <th scope="col" class="py-3 px-4 text-right text-xs font-semibold uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="musicTableBody" class="bg-gray-800 divide-y divide-gray-700">
                    <!-- Music rows will be injected here by JavaScript -->
                </tbody>
            </table>

            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mt-6">
                <button id="prevPageBtn" class="pagination-btn bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Previous Page</button>
                <span id="pageInfo" class="text-sm font-medium text-gray-400"></span>
                <button id="nextPageBtn" class="pagination-btn bg-gray-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Next Page</button>
            </div>
        </div>
        
        <!-- Audio Player -->
        <div id="audioPlayerContainer" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800 p-4 border-t border-gray-700 shadow-xl z-50">
            <h3 id="currentSongTitle" class="text-sm font-semibold text-gray-300 mb-2"></h3>
            <audio id="audioPlayer" controls loop class="w-full">
            </audio>
        </div>
        
        <!-- Footer with "Made with love" line -->
        <footer class="text-center text-sm text-gray-500 mt-8 pt-8 border-t border-gray-700">
            Made with &#x2764; by Jenny 2025
        </footer>
    </div>

    <!-- The new modal for download status -->
    <div id="downloadStatusModal" class="modal-overlay hidden">
        <div class="bg-blue-700 text-white p-6 rounded-xl shadow-lg text-center">
            <p id="modalStatusText" class="text-lg font-semibold"></p>
            <div class="flex justify-center mt-4">
                <div class="spinner w-8 h-8 rounded-full border-4 border-gray-200 border-t-transparent"></div>
            </div>
        </div>
    </div>

    <script>
        // This JavaScript code has been obfuscated to make it difficult to read.
        document.addEventListener('DOMContentLoaded',()=> {
            const h=document.getElementById('fetchBtn'),v=document.getElementById('searchKey'),a=document.getElementById('musicTableBody'),S=document.getElementById('loadingIndicator'),p=document.getElementById('statusMessage'),b=document.getElementById('musicListContainer'),y=document.getElementById('downloadAllBtn'),k=document.getElementById('selectAllBtn'),c=document.getElementById('clearSelectionsBtn'),f=document.getElementById('masterCheckbox'),w=document.getElementById('globalQualitySelect'),g=document.getElementById('applyQualityBtn'),u=document.getElementById('prevPageBtn'),d=document.getElementById('nextPageBtn'),I=document.getElementById('pageInfo'),B=document.getElementById('downloadDelay'),z=document.getElementById('audioPlayerContainer'),x=document.getElementById('audioPlayer'),l=document.getElementById('currentSongTitle'),m=document.createElement('div'),j=document.getElementById('downloadStatusModal'),L=document.getElementById('modalStatusText');
            const O='https://music.wjhe.top/api/music/joox/search',_O='https://music.wjhe.top/api/music/joox/url';
            let A=[],C=1,E=1;const M=20;let F=null;
            function P(e){m.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4',m.innerHTML=`
                    <div class="bg-gray-800 rounded-xl p-6 text-center max-w-sm w-full shadow-2xl space-y-4">
                        <p class="text-white text-lg">${e}</p>
                        <button class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-700" onclick="this.parentNode.parentNode.remove();">OK</button>
                    </div>
                `,document.body.appendChild(m)}
            async function T(e,t){if(!e){P('Please enter a search key.');return}p.textContent='',S.classList.remove('hidden'),a.innerHTML='',b.classList.add('hidden'),j.classList.add('hidden'),A=[],f.checked=!1,console.log(`Attempting to fetch music for "${e}" on page ${t}`);try{const o=`${O}?key=${encodeURIComponent(e)}&pageIndex=${t}&pageSize=${M}`,n='https://cors.eu.org/'+o,s=await fetch(n);if(!s.ok){console.error('HTTP error from proxy:',s.status);throw new Error(`HTTP error! status: ${s.status}`)}const r=await s.json();if(r.data&&r.data.data&&r.data.data.length>0){A=r.data.data;const i=r.data.pagingVO;C=i.pageIndex,E=Math.ceil(i.totalNum/i.pageSize),D(),N(A),b.classList.remove('hidden')}else{p.textContent='No music data found for this search. Please try a different key.',D()}}catch(o){console.error('Error fetching music data:',o),p.textContent='Failed to fetch music. Please check your search key and network connection.'}finally{S.classList.add('hidden')}}
            function D(){u.disabled=C<=1,d.disabled=C>=E,I.textContent=`Page ${C} of ${E}`}
            h.addEventListener('click',()=>{const e=v.value.trim();C=1,T(e,C)}),v.addEventListener('keypress',e=>{e.key==='Enter'&&(e.preventDefault(),h.click())}),u.addEventListener('click',()=>{C>1&&(C--,T(v.value.trim(),C))}),d.addEventListener('click',()=>{C<E&&(C++,T(v.value.trim(),C))})
            function N(e){a.innerHTML='',w.innerHTML='';const t=new Set,o={};e.forEach(i=>{if(i.fileLinks&&Array.isArray(i.fileLinks))i.fileLinks.forEach(H=>{const K=`${H.quality}_${H.format}`;if(!t.has(K)){t.add(K),o[H.format]||(o[H.format]=[]),o[H.format].push({quality:H.quality,value:K})}})});for(const i in o){const n=document.createElement('optgroup');n.label=i.toUpperCase(),o[i].sort((e,t)=>t.quality-e.quality).forEach(e=>{const t=document.createElement('option');t.value=e.value,t.textContent=`${e.quality}kbps (${i})`,n.appendChild(t)}),w.appendChild(n)}F&&w.value===F&&w.value||(F=w.value);e.forEach((i,n)=>{const s=document.createElement('tr');s.classList.add('hover:bg-gray-700','transition-colors','duration-200'),n%2===0?s.classList.add('bg-gray-800'):s.classList.add('bg-gray-800');const r=document.createElement('select');r.classList.add('w-full','bg-gray-700','border','border-gray-600','rounded-lg','p-2','text-gray-200');let V={quality:1/0,format:''},G={quality:0,format:''};i.fileLinks&&Array.isArray(i.fileLinks)&&i.fileLinks.forEach(e=>{const t=document.createElement('option');t.value=`${e.quality}_${e.format}`,t.textContent=`${e.quality}kbps (${e.format})`,r.appendChild(t),e.quality<V.quality&&(V=e),e.quality>G.quality&&(G=e)});G.quality!==0&&(r.value=`${G.quality}_${G.format}`);const H=document.createElement('button');H.classList.add('bg-blue-600','text-white','font-medium','px-3','py-1','rounded-xl','hover:bg-blue-700','transition-colors','download-button','text-sm'),H.textContent='Download',H.addEventListener('click',()=>{const[e,t]=r.value.split('_');_H(H,i.ID,e,t,i.title,i.singers[0].name)});const K=document.createElement('button');K.classList.add('bg-purple-600','text-white','font-medium','px-3','py-1','rounded-xl','hover:bg-purple-700','transition-colors','play-button','text-sm','ml-2'),K.innerHTML='&#9654;',K.setAttribute('data-song-id',i.ID),K.addEventListener('click',()=>{let e=V.quality,t=V.format;U(i.ID,e,t,i.title,i.singers[0].name)}),s.innerHTML=`
                        <td class="py-4 px-4 text-sm">
                            <input type="checkbox" class="song-checkbox rounded text-blue-600 focus:ring-blue-500" data-song-id="${i.ID}" data-title="${encodeURIComponent(i.title)}" data-artist="${encodeURIComponent(i.singers[0].name)}">
                        </td>
                        <td class="py-4 px-4 text-sm font-medium flex items-center"></td>
                        <td class="py-4 px-4 text-sm text-gray-400 hidden sm:table-cell">${i.singers.map(e=>e.name).join(', ')}</td>
                        <td class="py-4 px-4 text-sm text-gray-400 hidden sm:table-cell">${i.album.name}</td>
                        <td class="py-4 px-4 text-sm"></td>
                        <td class="py-4 px-4 text-right text-sm"></td>
                    `;const j=s.querySelector('td:nth-child(2)');j.textContent=i.title,j.appendChild(K),s.querySelector('td:nth-child(5)').appendChild(r);const l=s.querySelector('td:nth-child(6)');l.appendChild(H),a.appendChild(s)})
            }
            function Q(e,t){document.querySelectorAll('#musicTableBody select').forEach((o,n)=>{const s=t[n];let r=!1;for(const i of s.fileLinks)if(`${i.quality}_${i.format}`===e){o.value=e,r=!0;break}if(!r){const[i,h]=e.split('_');let V={quality:0};for(const G of s.fileLinks)G.format===h&&G.quality>V.quality&&(V=G);if(V.quality>0)o.value=`${V.quality}_${V.format}`;else{let G={quality:0};s.fileLinks.forEach(e=>{e.quality>G.quality&&(G=e)}),o.value=`${G.quality}_${G.format}`}}})}
            g.addEventListener('click',()=>{const e=w.value;F=e,Q(e,A)});
            async function _H(o,n,s,r,e,t){const i=o.textContent;o.textContent='Downloading...',o.disabled=!0;try{await R(n,s,r,e,t),o.textContent='Downloaded!',setTimeout(()=>{o.textContent=i,o.disabled=!1},2e3)}catch(h){console.error('Error downloading file:',h),P(`Failed to download song: ${e}. Please try again.`),o.textContent=i,o.disabled=!1}}
            async function R(e,t,o,n,s){const r=`${n} - ${s}.${o}`,i=`${_O}?ID=${e}&quality=${t}&format=${o}`,h='https://cors.eu.org/'+i;try{const V=await fetch(h);if(!V.ok)throw new Error(`HTTP error! status: ${V.status}`);const G=await V.blob(),H=window.URL.createObjectURL(G),K=document.createElement('a');K.href=H,K.download=r,document.body.appendChild(K),K.click(),K.remove(),window.URL.revokeObjectURL(H)}catch(V){console.error('Error downloading file:',V);throw V}}
            async function U(t,o,n,s,r){const e=`${_O}?ID=${t}&quality=${o}&format=${n}`,i='https://cors.eu.org/'+e,p=document.querySelector(`button[data-song-id="${t}"]`),b=`<div class="spinner w-4 h-4 rounded-full border-2 border-gray-600 border-t-white"></div>`,y=p.innerHTML;p.innerHTML=b,p.disabled=!0;try{const k=await fetch(i);if(!k.ok)throw new Error(`HTTP error! status: ${k.status}`);const c=await k.blob(),f=window.URL.createObjectURL(c);if(x.src)window.URL.revokeObjectURL(x.src);x.src=f,x.play(),z.classList.remove('hidden'),l.textContent=`Now Playing: ${r} - ${s}`,document.title=`${r} - ${s}`}catch(w){console.error('Error playing song:',w),P(`Failed to play song: ${s}. Please try again.`),p.innerHTML=y,p.disabled=!1}finally{p.innerHTML=y,p.disabled=!1}}
            f.addEventListener('change',()=>{const e=document.querySelectorAll('.song-checkbox');e.forEach(t=>{t.checked=f.checked})}),k.addEventListener('click',()=>{const e=document.querySelectorAll('.song-checkbox');e.forEach(t=>{t.checked=!0}),f.checked=!0}),c.addEventListener('click',()=>{const e=document.querySelectorAll('.song-checkbox');e.forEach(t=>{t.checked=!1}),f.checked=!1}),y.addEventListener('click',async()=>{const e=Array.from(document.querySelectorAll('.song-checkbox:checked')),t=parseInt(B.value,10)||1,o=t*1e3;if(e.length===0){P('Please select at least one song to download.');return}j.classList.remove('hidden');for(let n=0;n<e.length;n++){const s=e[n],r=s.dataset.songId,i=decodeURIComponent(s.dataset.title),h=decodeURIComponent(s.dataset.artist),u=s.closest('tr'),d=u.querySelector('select'),[a,p]=d.value.split('_');L.textContent=`Downloading song ${n+1} of ${e.length}: ${i}`;try{await R(r,a,p,i,h)}catch(V){console.error('Error during batch download:',V),P(`Failed to download: ${i}. Skipping to the next song.`)}if(n<e.length-1)await new Promise(V=>setTimeout(V,o))}L.textContent='All selected songs have been downloaded!',setTimeout(()=>{j.classList.add('hidden')},3e3)});
        });
    </script>

</body>
</html>
