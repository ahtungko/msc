<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="iMusic" />
    <meta name="theme-color" content="#000000" >
    <meta name="google" content="notranslate" >
    <title>iMusic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #0c0c0c;
            color: #fff;
            overflow-x: hidden;
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -2;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 顶部导航 */
        .navbar {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0; /* 防止logo被压缩 */
        }

        .logo i {
            color: #ff6b6b;
            font-size: 28px;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 40px;
            position: relative;
        }

        .search-wrapper {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .search-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            outline: none;
            min-width: 0; /* 允许输入框收缩 */
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .source-select {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 12px 15px;
            outline: none;
            cursor: pointer;
            display: block; /* 默认显示 */
        }

        .source-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        .search-btn {
            background: #ff6b6b;
            border: none;
            color: #fff;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px; /* 确保按钮不会太小 */
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .search-btn:hover {
            background: #ff5252;
        }

        /* 主要内容区域 - 关键修复：添加容器宽度控制 */
        .main-container {
            max-width: 1600px; /* 确保有一个最大宽度 */
            margin: 0 auto;
            padding: 30px;
            display: flex;
            gap: 25px;
            min-height: calc(100vh - 200px);
            width: 100%;
            box-sizing: border-box;
        }

        /* 搜索结果区域 */
        .content-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 0;
            overflow: hidden;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            /* 关键修复：让它填充可用空间 */
            flex: 1; 
            /* 确保不会因为内容变化而影响宽度 */
            width: 0;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            /* 确保子元素不会被压缩 */
            flex-wrap: nowrap;
        }
        
        .playlist-tag-indicator {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            padding: 2px 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #resultsTitle {
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
            padding: 2px 4px;
            transition: all 0.3s ease;
        }

        .search-results {
            max-height: 250px; /* 限制最大高度 */
            min-height: 250px; /* 确保最小高度 */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            /* 使内容区域填充剩余空间 */
            flex: 1;
        }

        /* 当显示搜索结果而不是歌单时，设置单独的max-height */
        .search-results.search-results-tall {
            max-height: 600px;
        }

        /* 当显示搜索结果而不是歌单时，设置单独的max-height */
        .search-results:not(:has(.playlist-tag-indicator:visible)) {
            max-height: 600px;
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-results::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px 0px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
            /* 关键修复：防止内容溢出 */
            max-width: 100%;
        }

        .song-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .song-item:hover::before {
            left: 100%;
        }

        .song-item.active {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1));
            border: 1px solid rgba(255, 107, 107, 0.5);
        }

        .song-index {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0; /* 防止被压缩 */
        }

        .song-item.active .song-index {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: #fff;
        }

        .song-info {
            flex: 1;
            min-width: 0; /* 允许收缩 */
        }

        .song-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 播放器区域 */
        .player-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* 移除 position: sticky 以确保高度一致 */
            display: flex;
            flex-direction: column;
            /* 使高度与 content-section 一致 */
            height: auto;
            min-height: 100%;
            /* 关键修复：防止内容溢出影响布局 */
            max-width: 100%;
            box-sizing: border-box;
            /* 使宽度与 content-section 一致 */
            flex: 1;
            /* 确保不会因为内容变化而影响宽度 */
            width: 0;
        }
        
        /* 播放器歌词显示 - 关键修复：完全控制宽度 */
        .player-lyrics-container {
            margin: 20px 0;
            height: 150px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(5px);
            /* 关键修复：固定宽度并防止溢出 */
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            /* 防止内容溢出 */
            overflow: hidden;
            /* 添加过渡动画使高度变化更平滑 */
            transition: height 0.15s ease; /* 缩短过渡时间使变化更快 */
        }
        
        .player-lyrics-wrapper {
            position: relative;
            height: 100%;
            overflow-y: auto;
            display: block;
            /* 关键修复：隐藏滚动条但保持功能 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            /* 防止内容溢出 */
            overflow-x: hidden;
        }
        
        /* 动态调整歌词容器高度的类 */
        .lyrics-auto-height {
            height: auto;
            min-height: 150px;
        }
        
        /* 隐藏webkit滚动条 */
        .player-lyrics-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .player-lyrics-list {
            position: relative;
            width: 100%;
            /* 关键修复：防止列表宽度受内容影响 */
            table-layout: fixed;
        }
        
        .player-lyric-line {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            padding: 0 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            /* 关键修复：确保行宽度固定，防止溢出 */
            width: 100%;
            box-sizing: border-box;
            /* 防止长文本影响布局 */
            max-width: 100%;
            /* 确保文本不会因为放大而溢出 */
            transform-origin: center;
            /* 调整行间距 */
            margin: 3px 0;
        }
        
        .player-lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            height: auto;
            min-height: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: clip;
            /* 限制最大宽度 */
            max-width: 100%;
            /* 调整行间距 */
            margin: 3px 0;
        }
        
        .player-lyric-line.current {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            /* 移除字号放大以避免宽度问题 */
            font-size: 14px;
            /* 增加与上下歌词的间距 */
            margin: 6px 0;
        }
        
        .player-lyric-line.current.long-text {
            font-size: 14px;
            /* 增加与上下歌词的间距 */
            margin: 6px 0;
        }
        
        .player-lyric-line.before-current,
        .player-lyric-line.after-current {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 模糊效果 */
        .player-lyric-line.first,
        .player-lyric-line.last {
            color: rgba(255, 255, 255, 0.3);
            filter: blur(1px);
        }
        
        /* 歌词校准控制 */
        .lyrics-adjust-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        /* 偏移量显示 */
        .lyrics-offset-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .player-lyrics-container:hover .lyrics-offset-display {
            opacity: 1;
        }
        
        .lyrics-adjust-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .lyrics-adjust-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .current-song {
            text-align: center;
            margin-bottom: 25px;
        }

        .current-cover-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .current-cover {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            border: 6px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .current-cover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        .current-cover::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        .current-cover.playing {
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .current-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            /* 防止标题过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            /* 防止艺术家信息过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 播放控制 */
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;   
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .control-btn.active {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .control-btn.small {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }

        .play-btn {
            width: 65px;
            height: 65px;
            font-size: 28px;
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff4444);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
        }

        /* 进度条 */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 音量控制 */
        .volume-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .volume-icon {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            flex-shrink: 0; /* 防止图标被压缩 */
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #ff6b6b;
            border-radius: 50%;
            cursor: pointer;
        }

        /* 音质选择 */
        .quality-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            flex-shrink: 0; /* 防止标签被压缩 */
        }

        .quality-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            outline: none;
            cursor: pointer;
            font-size: 14px;
            /* 防止选择框过宽 */
            max-width: 150px;
        }

        .quality-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        /* 下载区域 */
        .download-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            /* 防止按钮内容过宽 */
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .download-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 歌曲操作按钮 */
        .song-actions {
            display: flex;
            gap: 8px;
            margin-right: 15px;
            flex-shrink: 0; /* 防止按钮组被压缩 */
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            transform: scale(1.1);
        }

        /* 歌词容器 */
        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            padding-right: 10px;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .lyric-line {
            padding: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 6px;
            padding-left: 10px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
            /* 防止歌词过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .lyric-line.active {
            color: #ff6b6b;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.02);
            border-left: 3px solid #ff6b6b;
        }

        /* 歌单导入区域 */
        .playlist-import {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        /* 歌单详情 */
        .playlist-detail {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
            /* 确保不会占用太多空间 */
            flex-shrink: 0;
        }
        
        .playlist-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .playlist-cover {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0; /* 防止图片被压缩 */
        }
        
        .playlist-info-container {
            flex: 1;
            min-width: 0; /* 允许收缩 */
        }
        
        .playlist-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            /* 允许标题换行以避免被截断 */
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-creator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .creator-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0; /* 防止头像被压缩 */
        }
        
        .creator-name {
            font-weight: 500;
            /* 防止名字过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .playlist-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        
        .playlist-description {
            margin-bottom: 15px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            /* 允许描述换行显示 */
            white-space: normal;
            word-wrap: break-word;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .playlist-tag {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            /* 防止标签过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .import-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .import-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            outline: none;
            font-size: 14px;
            /* 防止输入框过宽 */
            min-width: 0;
        }

        .import-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .import-btn {
            padding: 12px 20px;
            background: #ff6b6b;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .import-btn:hover {
            background: #ff5252;
        }

        .saved-playlists {
            margin-top: 20px;
        }

        .playlist-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* 防止歌单项目过宽 */
            max-width: 100%;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item .playlist-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .playlist-item .playlist-name {
            font-weight: 500;
            /* 允许歌单名称换行以避免挤出操作按钮 */
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-item .playlist-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0; /* 防止计数被压缩 */
            /* 限制文本长度 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .playlist-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0; /* 防止按钮组被压缩 */
        }

        .playlist-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .playlist-action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* 加载和错误状态 */
        .loading, .error, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading i, .error i, .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .loading i {
            animation: spin 1s linear infinite;
            color: #ff6b6b;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error i {
            color: #ff5252;
        }

        .empty-state i {
            color: rgba(255, 255, 255, 0.4);
        }

        /* 响应式设计 */
        @media (max-width: 1400px) {
            .main-container {
                gap: 20px;
                max-width: 1200px;
            }
            
            .content-section, .player-section {
                /* 在中等屏幕尺寸下重置宽度 */
                width: auto;
            }
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                /* 关键修复：确保容器不会因为内容而变宽 */
                width: 100%;
                max-width: 100%;
            }
            
            .nav-container {
                padding: 0 20px;
            }
            
            .search-container {
                margin: 0 20px;
            }
            
            .player-section {
                position: static;
                min-height: auto;
                height: auto;
            }
            
            /* 关键修复：确保所有子元素不会突破容器 */
            .content-section, .player-section {
                max-width: 100%;
                overflow: hidden;
                /* 在小屏幕尺寸下重置宽度 */
                width: auto;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
                padding: 0 15px;
            }
            
            .search-container {
                margin: 0;
                max-width: none;
                width: 100%;
                padding: 0;
            }
            
            .search-wrapper {
                width: 100%;
            }
            
            /* 在移动端显示来源选择 */
            .source-select {
                display: block;
            }
            
            /* 调整搜索按钮在移动端的显示 */
            .search-btn {
                padding: 12px 15px;
                min-width: 45px;
            }
            
            .search-btn i {
                font-size: 16px;
            }
            
            .current-cover {
                width: 180px;
                height: 180px;
            }
            
            .player-controls {
                gap: 15px;
            }
            
            .download-container {
                grid-template-columns: 1fr;
            }
            
            .import-form {
                flex-direction: column;
            }
            
            .import-btn {
                justify-content: center;
            }
            
            .playlist-header {
                flex-direction: column;
            }
            
            .playlist-cover {
                width: 100%;
                height: auto;
                aspect-ratio: 1/1;
            }
            
            /* 移动端歌词容器优化 */
            .player-lyrics-container {
                height: 120px; /* 固定高度以显示五行歌词 */
                padding: 8px;
                /* 关键修复：确保容器宽度固定 */
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                transition: none; /* 移动端禁用过渡动画 */
            }
            
            .player-lyric-line {
                font-size: 13px;
                height: 26px;
                line-height: 26px;
                padding: 0 10px;
                /* 防止文本溢出 */
                max-width: 100%;
                box-sizing: border-box;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                /* 移除字号放大以避免宽度问题 */
                font-size: 13px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
            
            .player-lyric-line.long-text {
                font-size: 11px;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current.long-text {
                font-size: 13px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
            
            .playlist-tag-indicator {
                font-size: 12px;
                padding: 2px 10px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                /* 修复移动端显示问题 */
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 20px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* 增加移动端搜索结果区域的高度 */
            .search-results {
                max-height: 380px; /* 增加最大高度 */
                min-height: 380px; /* 增加最小高度 */
            }
            
            /* 当显示搜索结果而不是歌单时，设置单独的max-height */
            .search-results.search-results-tall {
                max-height: 600px;
            }
        }

        /* 针对非常小的屏幕优化 */
        @media (max-width: 480px) {
            .nav-container {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo i {
                font-size: 24px;
            }
            
            .search-input {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .source-select {
                padding: 10px 10px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 10px 12px;
            }
            
            .content-section, .player-section, .playlist-import {
                padding: 20px 15px;
            }
            
            .song-item {
                padding: 12px 15px;
            }
            
            .song-name {
                font-size: 15px;
            }
            
            .song-artist {
                font-size: 13px;
            }
            
            .section-title {
                font-size: 18px;
                /* 确保子元素不会被压缩 */
                flex-wrap: nowrap;
            }
            
            .playlist-tag-indicator {
                font-size: 11px;
                padding: 1px 8px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                /* 修复小屏幕显示问题 */
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 18px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* 移动端歌单项目优化 */
            .playlist-item .playlist-name {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .playlist-item .playlist-count {
                font-size: 12px;
            }   
            
            .player-lyric-line {
                font-size: 12px;
                height: 24px;
                line-height: 24px;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                /* 移除字号放大以避免宽度问题 */
                font-size: 12px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
        }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* 滚动歌词样式 */
        .lyrics-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            padding: 4px 0;
        }

        .custom-playlist-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* margin-top: 25px; */
            /* 关键修复：让它也填充可用空间，与 .content-section 平分 */
            flex: 1;
            min-width: 0; /* 允许它收缩，防止内部元素溢出 */
        }
        @media (max-width: 768px) {
            .logo {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>

    <nav class="navbar" role="navigation" aria-label="主导航">
        <div class="nav-container">
            <div class="logo" role="banner">
                <i class="fas fa-music" aria-hidden="true"></i>
                <span></span>
            </div>
            
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑..." id="searchInput" aria-label="搜索音乐">
                    <select class="source-select" id="sourceSelect" aria-label="选择音乐来源">
                        <option value="netease">网易云音乐</option>
                        <option value="kuwo">酷我音乐</option>
                        <option value="joox">JOOX</option>
                        <option value="ximalaya">喜马拉雅</option>
                    </select>
                    <button class="search-btn" onclick="searchMusic()" aria-label="搜索">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-list-music"></i>
                <span class="playlist-tag-indicator" style="display: none;">歌单</span>
                <span id="resultsTitle">搜索结果</span>
                <button id="clearPlaylistBtn" class="action-btn" style="margin-left: auto; display: none;" onclick="clearPlaylistView()" title="清除歌单视图">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            <div class="search-results" id="searchResults">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            </div>

            <div class="playlist-detail" id="playlistDetail">
                <div class="playlist-header">
                    <img class="playlist-cover" id="playlistCover" src="" alt="歌单封面">
                    <div class="playlist-info-container">
                        <h2 class="playlist-title" id="playlistTitle"></h2>
                        <div class="playlist-creator">
                            <img class="creator-avatar" id="creatorAvatar" src="" alt="创建者头像">
                            <span class="creator-name" id="creatorName"></span>
                        </div>
                        <div class="playlist-stats">
                            <span id="playlistPlayCount"></span>
                            <span id="playlistTrackCount"></span>
                        </div>
                        <div class="playlist-tags" id="playlistTags">
                            </div>
                    </div>
                </div>
                <div class="playlist-description" id="playlistDescription"></div>
            </div>
            
            <div class="playlist-import">
                <h2 class="section-title">
                    <i class="fas fa-folder-plus"></i>
                    导入网易云歌单
                </h2>
                <div class="import-form">
                    <input type="text" class="import-input" id="playlistIdInput" placeholder="粘贴 ID 或 链接">
                    <button class="import-btn" onclick="importPlaylist()">
                        <i class="fas fa-download"></i>
                        <span>导入</span>
                    </button>
                </div>
                <div class="saved-playlists" id="savedPlaylists">
                    </div>
            </div>
        </div>

        <div class="player-section">
            <div class="current-song">
                <div class="current-cover-container">
                    <img class="current-cover" id="currentCover" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=" alt="专辑封面">
                </div>
                <div class="current-info">
                    <h3 id="currentTitle">未选择歌曲</h3>
                    <p id="currentArtist">请搜索并选择要播放的歌曲</p>
                </div>
            </div>

            <div class="player-lyrics-container" id="playerLyricsContainer">
                <div class="lyrics-offset-display" id="lyricsOffsetDisplay">±0.0</div>
                <div class="player-lyrics-wrapper" id="playerLyricsWrapper">
                    <div class="player-lyrics-list" id="playerLyricsList"></div>
                </div>

            </div>
                  <div class="lyrics-adjust-controls">
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(0.5)" title="歌词延后0.5秒" aria-label="歌词延后0.5秒">←</button>
                    <button class="lyrics-adjust-btn" onclick="resetLyricsOffset()" title="重置歌词偏移" aria-label="重置歌词偏移">↺</button>
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(-0.5)" title="歌词提前0.5秒" aria-label="歌词提前0.5秒">→</button>
                </div>
            <div class="player-controls">
                <button class="control-btn small" onclick="toggleRepeat()" aria-label="重复播放" id="repeatBtn">
                    <i class="fas fa-repeat" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="previousSong()" aria-label="上一首">
                    <i class="fas fa-step-backward" aria-hidden="true"></i>
                </button>
                <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()" aria-label="播放/暂停">
                    <i class="fas fa-play" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="nextSong()" aria-label="下一首">
                    <i class="fas fa-step-forward" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="toggleShuffle()" aria-label="随机播放" id="shuffleBtn">
                    <i class="fas fa-shuffle" aria-hidden="true"></i>
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <div class="quality-container">
                <div class="quality-label">
                    <i class="fas fa-music"></i>
                    <span>音质</span>
                </div>
                <select class="quality-select" id="qualitySelect">
                    <option value="128">标准 128K</option>
                    <option value="192">较高 192K</option>
                    <option value="320" selected>高品质 320K</option>
                    <option value="740">无损 FLAC</option>
                    <option value="999">Hi-Res</option>
                </select>
            </div>

            <div class="volume-container">
                <i class="fas fa-volume-up volume-icon"></i>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" onchange="setVolume(this.value)">
            </div>

            <div class="download-container">
                <button class="download-btn" onclick="downloadCurrentSong()" id="downloadSongBtn" disabled>
                    <i class="fas fa-download"></i>
                    <span>下载音乐</span>
                </button>
                <button class="download-btn" onclick="downloadCurrentLyric()" id="downloadLyricBtn" disabled>
                    <i class="fas fa-file-text"></i>
                    <span>下载歌词</span>
                </button>
            </div>

            <audio id="audioPlayer" preload="metadata"></audio>
        </div>
        
        <div class="custom-playlist-section">
            <h2 class="section-title">
                <i class="fas fa-stream"></i>
                我的播放列表 (<span id="customPlaylistCount">0</span>)
                <button id="clearCustomPlaylistBtn" class="action-btn" style="margin-left: auto;" onclick="clearCustomPlaylist()" title="清空播放列表">
                    <i class="fas fa-trash"></i>
                </button>
            </h2>
            <div class="custom-playlist" id="customPlaylist">
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://music-api.gdstudio.xyz/api.php';
        let currentPlaylist = []; // 仅存储搜索结果
        let activePlaylist = []; // 实际用于播放的列表
        let customPlaylist = JSON.parse(localStorage.getItem('customPlaylist')) || []; // 自定义的播放列表
        let currentIndex = -1;
        let currentPlaylistId = null; // 当前播放的歌单ID
        let currentLyrics = [];
        let isPlaying = false;
        let savedPlaylists = JSON.parse(localStorage.getItem('savedPlaylists')) || [];
        let repeatMode = 0; // 0: No repeat, 1: Repeat all, 2: Repeat one
        let isShuffling = false;
        let originalPlaylist = [];
        let shuffledPlaylist = [];

        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const totalTimeSpan = document.getElementById('totalTime');
        const playerLyricsList = document.getElementById('playerLyricsList');
        const playerLyricsWrapper = document.getElementById('playerLyricsWrapper');
        const playerLyricsContainer = document.getElementById('playerLyricsContainer');
        const lyricsOffsetDisplay = document.getElementById('lyricsOffsetDisplay');
        const currentCover = document.getElementById('currentCover');
        
        // 歌词偏移量（用于手动校准）
        let lyricsOffset = 0;
        let currentSongId = null;
        
        // 歌词滚动相关变量
        let isLyricsScrolling = false;
        let lyricsScrollTimeout = null;
        let lastScrollTime = 0;
        
        // 高度同步相关变量
        let initialContentHeight = 0;
        let initialLyricsHeight = 150; // 初始歌词容器高度
        let initialPlayerHeight = 0; // 初始player-section高度
        let contentResizeObserver = null;
        let heightSyncInitialized = false;

        function clearCustomPlaylist() {
            if (customPlaylist.length === 0) {
                showNotification('播放列表已是空的', 'warning');
                return;
            }

            if (confirm('确定要清空我的播放列表吗？')) {
                customPlaylist = [];
                saveCustomPlaylist();
                updateCustomPlaylistUI();
                showNotification('已清空播放列表', 'success');

                // Stop playing if the song is from this playlist
                if (activePlaylist === customPlaylist) {
                    audioPlayer.pause();
                    currentIndex = -1;
                }
            }
        }
        // 保存自定义播放列表
        function saveCustomPlaylist() {
            localStorage.setItem('customPlaylist', JSON.stringify(customPlaylist));
        }

        // 从本地加载自定义播放列表
        function loadCustomPlaylist() {
            const savedList = localStorage.getItem('customPlaylist');
            if (savedList) {
                customPlaylist = JSON.parse(savedList);
            }
        }
        // 搜索音乐
        async function searchMusic() {
            const keyword = document.getElementById('searchInput').value.trim();
            const source = document.getElementById('sourceSelect').value;
            
            if (!keyword) {
                showNotification('请输入搜索关键词', 'warning');
                return;
            }

            // 重置标题显示
            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            // 隐藏歌单标签
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            // 隐藏歌单详情区域
            document.getElementById('playlistDetail').style.display = 'none';
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>正在搜索音乐...</div>
                </div>
            `;
            
            // 为搜索结果添加特殊样式类
            resultsContainer.classList.add('search-results-tall');

            try {
                const response = await fetch(`${API_BASE}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=30`);
                const data = await response.json();

                if (data && data.length > 0) {
                    currentPlaylist = data; // 存储搜索结果
                    activePlaylist = data; // 播放列表指向搜索结果
                    currentPlaylistId = null; // 重置当前播放的歌单ID
                    displaySearchResults(data);
                    // 重新初始化高度同步
                    setTimeout(() => {
                        heightSyncInitialized = false;
                        initHeightSync();
                    }, 100);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>未找到相关歌曲，请尝试其他关键词</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <i class="fas fa-wifi"></i>
                        <div>网络连接失败，请检查网络后重试</div>
                    </div>
                `;
            }
        }

        // 添加到自定义播放列表
        function addToPlaylist(event, index) {
            event.stopPropagation();
            
            const songToAdd = currentPlaylist[index];
            
            const isSongInPlaylist = customPlaylist.some(song => song.id === songToAdd.id);
            if (isSongInPlaylist) {
                showNotification('这首歌已在播放列表中', 'warning');
                return;
            }
            
            customPlaylist.push(songToAdd);
            // 新增：保存自定义播放列表到 localStorage
            saveCustomPlaylist();
            showNotification(`已添加 "${songToAdd.name}" 到播放列表`, 'success');
            
            if (customPlaylist.length === 1) {
                activePlaylist = customPlaylist;
                playSong(0); 
            }
            
            updateCustomPlaylistUI();
        }

        // 移除自定义播放列表中的歌曲
        function removeFromCustomPlaylist(event, index) {
            event.stopPropagation();
            if (index >= 0 && index < customPlaylist.length) {
                const removedSong = customPlaylist.splice(index, 1)[0];
                // 新增：保存自定义播放列表到 localStorage
                saveCustomPlaylist();
                showNotification(`已移除 "${removedSong.name}"`, 'info');
                
                // 如果移除的歌曲是正在播放的歌曲，并且列表不为空，则播放下一首
                if (activePlaylist === customPlaylist && currentIndex === index) {
                    if (customPlaylist.length > 0) {
                        // 如果移除的是最后一首，则播放新的最后一首
                        if (index >= customPlaylist.length) {
                             playSong(customPlaylist.length - 1);
                        } else {
                            playSong(index);
                        }
                    } else {
                        // 列表为空，停止播放
                        audioPlayer.pause();
                    }
                }
                
                updateCustomPlaylistUI();
            }
        }

        // 更新自定义播放列表 UI
        function updateCustomPlaylistUI() {
            const playlistContainer = document.getElementById('customPlaylist');
            const playlistCount = document.getElementById('customPlaylistCount');
            
            playlistContainer.innerHTML = '';
            playlistCount.textContent = customPlaylist.length;
            
            if (customPlaylist.length === 0) {
                playlistContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-list-ul"></i>
                        <div>播放列表为空</div>
                    </div>
                `;
                return;
            }
            
            customPlaylist.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                
                // 为整个歌曲条目添加点击事件，以播放歌曲
                songItem.onclick = () => {
                    activePlaylist = customPlaylist;
                    playSong(index);
                };
                
                songItem.innerHTML = `
                    <div class="song-index" aria-hidden="true">${(index + 1).toString().padStart(2, '0')}</div>
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}</div>
                    </div>
                    <div class="song-actions">
                         <button class="action-btn" onclick="removeFromCustomPlaylist(event, ${index})" title="从列表中移除">
                            <i class="fas fa-minus" aria-hidden="true"></i>
                        </button>
                    </div>
                `;
                playlistContainer.appendChild(songItem);
            });
        }

// Toggle repeat mode
function toggleRepeat() {
    repeatMode = (repeatMode + 1) % 3;
    const repeatBtn = document.getElementById('repeatBtn');
    const icon = repeatBtn.querySelector('i');
    
    // Reset all states
    repeatBtn.classList.remove('active');
    
    // Update button based on the new mode
    if (repeatMode === 1) {
        icon.className = 'fas fa-repeat'; // Repeat all
        repeatBtn.classList.add('active');
        showNotification('已开启列表循环', 'info');
    } else if (repeatMode === 2) {
        icon.className = 'fas fa-redo-alt'; // 使用备用图标 // Single-loop icon
        repeatBtn.classList.add('active');
        showNotification('已开启单曲循环', 'info');
    } else {
        icon.className = 'fas fa-repeat'; // No repeat
        showNotification('已关闭循环', 'info');
    }
}

        // 切换随机播放模式
        function toggleShuffle() {
            isShuffling = !isShuffling;
            const shuffleBtn = document.getElementById('shuffleBtn');
            shuffleBtn.classList.toggle('active', isShuffling);
            
            if (isShuffling) {
                // 如果当前播放列表是自定义列表，则打乱它
                if (activePlaylist === customPlaylist) {
                    originalPlaylist = [...customPlaylist];
                    shuffledPlaylist = shuffleArray([...customPlaylist]);
                    activePlaylist = shuffledPlaylist;
                } else {
                    originalPlaylist = [...currentPlaylist];
                    shuffledPlaylist = shuffleArray([...currentPlaylist]);
                    activePlaylist = shuffledPlaylist;
                }

                showNotification('已开启随机播放', 'info');
            } else {
                // 恢复原始顺序
                activePlaylist = originalPlaylist;
                showNotification('已关闭随机播放', 'info');
            }
            
            // 重新渲染列表以反映新顺序
            displaySearchResults(activePlaylist);
            // 找到新列表中的当前歌曲索引
            if (currentIndex !== -1 && activePlaylist.length > 0) {
                const currentSong = originalPlaylist[currentIndex];
                const newIndex = activePlaylist.findIndex(song => song.id === currentSong.id);
                currentIndex = newIndex !== -1 ? newIndex : 0;
                updateActiveItem();
            }
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 获取专辑图片URL
        async function getAlbumCoverUrl(song, size = 300) {
            if (song.picUrl) {
                return song.picUrl;
            }
            
            const picId = song.pic_id || song.id;
            
            if (!picId) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
            }

            try {
                const response = await fetch(`${API_BASE}?types=pic&source=${song.source}&id=${picId}&size=${size}`);
                const data = await response.json();
                
                if (data && data.url) {
                    return data.url;
                }
            } catch (error) {
                console.error('获取专辑图失败:', error);
            }
            
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
        }

        // 显示搜索结果
        async function displaySearchResults(songs) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            for (let index = 0; index < songs.length; index++) {
                const song = songs[index];
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.onclick = () => {
                    // 确保播放的是搜索结果列表
                    activePlaylist = currentPlaylist;
                    playSong(index);
                };

                songItem.innerHTML = `
                    <div class="song-index" aria-hidden="true">${(index + 1).toString().padStart(2, '0')}</div>
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}</div>
                    </div>
                    <div class="song-actions">
                        <button class="action-btn" onclick="addToPlaylist(event, ${index})" title="添加到播放列表" aria-label="添加到播放列表 ${song.name}">
                            <i class="fas fa-plus" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn" onclick="downloadSong(event, ${index})" title="下载音乐" aria-label="下载音乐 ${song.name}">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn" onclick="downloadLyric(event, ${index})" title="下载歌词" aria-label="下载歌词 ${song.name}">
                            <i class="fas fa-file-text" aria-hidden="true"></i>
                        </button>
                    </div>
                `;

                resultsContainer.appendChild(songItem);
            }
        }
        
        // 播放歌曲
        async function playSong(index) {
            if (index < 0 || index >= activePlaylist.length) return;

            currentIndex = index;
            const song = activePlaylist[index];

            await updateCurrentSongInfo(song);
            updateActiveItem();
            
            lyricsOffset = 0;
            currentSongId = song.id;
            updateLyricsOffsetDisplay();

            try {
                showNotification('正在加载音乐...', 'info');
                
                const quality = document.getElementById('qualitySelect').value;
                const urlResponse = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const urlData = await urlResponse.json();

                if (urlData && urlData.url) {
                    audioPlayer.src = urlData.url;
                    audioPlayer.load();
                    
                    loadLyrics(song);
                    
                    document.getElementById('downloadSongBtn').disabled = false;
                    document.getElementById('downloadLyricBtn').disabled = false;
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButton();
                            currentCover.classList.add('playing');
                            showNotification(`开始播放 (${getQualityText(urlData.br || quality)})`, 'success');
                        }).catch(error => {
                            console.error('播放失败:', error);
                            showNotification('播放失败，请尝试其他歌曲', 'error');
                        });
                    }

                    if ('mediaSession' in navigator) {
                        const artworkUrl = await getAlbumCoverUrl(song, 500);
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.name,
                            artist: Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist,
                            album: song.album,
                            artwork: [
                                { src: artworkUrl, sizes: '512x512', type: 'image/jpeg' },
                            ]
                        });
                        navigator.mediaSession.setActionHandler('play', () => { togglePlay(); });
                        navigator.mediaSession.setActionHandler('pause', () => { togglePlay(); });
                        navigator.mediaSession.setActionHandler('nexttrack', () => { nextSong(); });
                        navigator.mediaSession.setActionHandler('previoustrack', () => { previousSong(); });
                    }
                } else {
                    showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
                }
            } catch (error) {
                console.error('播放失败:', error);
                showNotification('播放失败，请检查网络连接', 'error');
            }
        }

        // 获取音质文本
        function getQualityText(br) {
            const qualityMap = {
                '128': '标准音质',
                '192': '较高音质',
                '320': '高品质',
                '740': '无损音质',
                '999': 'Hi-Res音质'
            };
            return qualityMap[br] || `${br}K`;
        }

        // 下载当前播放的歌曲
        async function downloadCurrentSong() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载的歌曲', 'warning');
                return;
            }
            
            const song = activePlaylist[currentIndex];
            await downloadSong(null, currentIndex);
        }

        // 下载当前播放的歌词
        async function downloadCurrentLyric() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载歌词的歌曲', 'warning');
                return;
            }
            
            await downloadLyric(null, currentIndex);
        }

        // 下载歌曲
        async function downloadSong(event, index) {
            if (event) event.stopPropagation();
            const song = currentPlaylist[index];
            const quality = document.getElementById('qualitySelect').value;
            
            try {
                showNotification('正在获取下载链接...', 'info');
                
                const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const data = await response.json();
                
                if (data && data.url) {
                    const link = document.createElement('a');
                    link.href = data.url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.mp3`;
                    link.target = '_blank';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('开始下载音乐文件', 'success');
                } else {
                    showNotification('无法获取下载链接', 'error');
                }
            } catch (error) {
                console.error('下载失败:', error);
                showNotification('下载失败，请稍后重试', 'error');
            }
        }

        // 下载歌词
        async function downloadLyric(event, index) {
            if (event) event.stopPropagation();
            const song = currentPlaylist[index];
            
            try {
                showNotification('正在获取歌词...', 'info');
                
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();
                
                if (data && data.lyric) {
                    let lyricContent = `歌曲：${song.name}\n`;
                    lyricContent += `歌手：${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}\n`;
                    lyricContent += `专辑：${song.album}\n`;
                    lyricContent += `来源：${song.source}\n\n`;
                    lyricContent += data.lyric;
                    
                    if (data.tlyric) {
                        lyricContent += '\n=== 翻译歌词 ===\n';
                        lyricContent += data.tlyric;
                    }
                    
                    const blob = new Blob([lyricContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.lrc`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(url);
                    showNotification('歌词下载完成', 'success');
                } else {
                    showNotification('该歌曲暂无歌词', 'warning');
                }
            } catch (error) {
                console.error('下载歌词失败:', error);
                showNotification('下载歌词失败，请稍后重试', 'error');
            }
        }

        // 音质改变时重新加载当前歌曲
        document.getElementById('qualitySelect').addEventListener('change', () => {
            if (currentIndex !== -1 && audioPlayer.src) {
                const currentTime = audioPlayer.currentTime;
                const wasPlaying = isPlaying;
                
                playSong(currentIndex).then(() => {
                    audioPlayer.currentTime = currentTime;
                    if (!wasPlaying) {
                        audioPlayer.pause();
                    }
                });
            }
        });

        // 更新当前歌曲信息
        async function updateCurrentSongInfo(song) {
            document.getElementById('currentTitle').textContent = song.name;
            document.getElementById('currentArtist').textContent =
                `${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}`;

            const coverUrl = await getAlbumCoverUrl(song, 500);
            currentCover.src = coverUrl;
        }

        // 更新活跃项目
        function updateActiveItem() {
            // 移除所有歌曲的高亮状态，以确保只有一个高亮
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('active');
            });

            if (currentIndex === -1 || !activePlaylist[currentIndex]) {
                return;
            }

            const currentSongId = activePlaylist[currentIndex].id;
            
            // 如果正在播放搜索结果列表或导入的歌单
            const searchItems = document.getElementById('searchResults').querySelectorAll('.song-item');
            searchItems.forEach((item, index) => {
                if (currentPlaylist[index] && currentPlaylist[index].id === currentSongId) {
                    item.classList.add('active');
                }
            });

            // 如果正在播放自定义播放列表
            const customItems = document.getElementById('customPlaylist').querySelectorAll('.song-item');
            customItems.forEach((item, index) => {
                if (customPlaylist[index] && customPlaylist[index].id === currentSongId) {
                    item.classList.add('active');
                }
            });
        }

        // 更新播放按钮
        function updatePlayButton() {
            const icon = playBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        // 加载歌词
        async function loadLyrics(song) {
            lyricsOffset = 0;
            currentSongId = song.id;
            updateLyricsOffsetDisplay();
            
            try {
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();

                if (data && data.lyric) {
                    parseLyrics(data.lyric);
                } else {
                    displayPlayerLyrics([]);
                    currentLyrics = [];
                }
            } catch (error) {
                console.error('获取歌词失败:', error);
                displayPlayerLyrics([]);
                currentLyrics = [];
            }
        }

        // 解析LRC歌词
        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            currentLyrics = [];

            lines.forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const text = match[4].trim();

                    if (text) {
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        currentLyrics.push({ time, text });
                    }
                }
            });

            currentLyrics.sort((a, b) => a.time - b.time);
            displayPlayerLyrics(currentLyrics);
            
            initLyricsScrollListeners();
        }

        // 显示播放器区域的多行歌词
        function displayPlayerLyrics(lyrics) {
            playerLyricsList.innerHTML = '';
            
            if (lyrics.length === 0) {
                playerLyricsList.innerHTML = '<div class="player-lyric-line empty">暂无歌词</div>';
                return;
            }
            
            for (let i = 0; i < lyrics.length; i++) {
                const lyricLine = document.createElement('div');
                lyricLine.className = 'player-lyric-line';
                lyricLine.textContent = lyrics[i].text;
                lyricLine.dataset.time = lyrics[i].time;
                
                if (lyrics[i].text.length > 30) {
                    lyricLine.classList.add('long-text');
                }
                
                playerLyricsList.appendChild(lyricLine);
            }
        }

        // 初始化歌词滚动事件监听器
        function initLyricsScrollListeners() {
            playerLyricsWrapper.removeEventListener('wheel', handleLyricsScroll);
            playerLyricsWrapper.removeEventListener('click', handleLyricClick);
            
            playerLyricsWrapper.addEventListener('wheel', handleLyricsScroll, { passive: false });
            
            playerLyricsWrapper.addEventListener('click', handleLyricClick);
        }

        // 处理歌词滚动事件
        function handleLyricsScroll(e) {
            e.preventDefault();
            playerLyricsWrapper.scrollTop += e.deltaY;
            isLyricsScrolling = true;
            lastScrollTime = Date.now();
            
            if (lyricsScrollTimeout) {
                clearTimeout(lyricsScrollTimeout);
            }
            
            lyricsScrollTimeout = setTimeout(() => {
                isLyricsScrolling = false;
                resetLyricsPosition();
            }, 3000);
        }

        // 处理歌词点击事件
        function handleLyricClick(e) {
            let target = e.target;
            while (target && !target.classList.contains('player-lyric-line')) {
                target = target.parentElement;
            }
            
            if (target && target.classList.contains('player-lyric-line')) {
                const time = parseFloat(target.dataset.time);
                
                if (!isNaN(time)) {
                    audioPlayer.currentTime = time;
                    showNotification(`已跳转到 ${formatTime(time)}`, 'success');
                    
                    if (lyricsScrollTimeout) {
                        clearTimeout(lyricsScrollTimeout);
                    }
                    
                    isLyricsScrolling = false;
                    updateLyricHighlight();
                }
            }
        }

        // 重置歌词位置到当前播放位置
        function resetLyricsPosition() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset;
            let activeIndex = -1;

            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            
            if (activeIndex >= 0) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                if (lyricLines[activeIndex]) {
                    const containerHeight = playerLyricsWrapper.clientHeight;
                    const lineHeight = lyricLines[activeIndex].offsetHeight;
                    const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                    const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                    
                    playerLyricsWrapper.scrollTo({
                        top: Math.max(0, idealScrollTop),
                        behavior: 'smooth'
                    });
                }
            }
        }

        // 更新歌词高亮
        function updateLyricHighlight() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset;
            let activeIndex = -1;

            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if (activeIndex === -1) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                lyricLines.forEach(line => {
                    line.classList.remove('current', 'before-current', 'after-current', 'first', 'last');
                });
                return;
            }

            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            const linesToUpdate = [];
            
            lyricLines.forEach((line, index) => {
                let shouldUpdate = false;
                const classesToRemove = [];
                const classesToAdd = [];
                
                if (index === activeIndex) {
                    if (!line.classList.contains('current')) {
                        classesToAdd.push('current');
                        shouldUpdate = true;
                    }
                    ['before-current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } else if (index === activeIndex - 1) {
                    if (!line.classList.contains('before-current')) {
                        classesToAdd.push('before-current');
                        shouldUpdate = true;
                    }
                    ['current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } else if (index === activeIndex + 1) {
                    if (!line.classList.contains('after-current')) {
                        classesToAdd.push('after-current');
                        shouldUpdate = true;
                    }
                    ['current', 'before-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } else {
                    const hasUnwantedClasses = line.classList.contains('current') || 
                                             line.classList.contains('before-current') || 
                                             line.classList.contains('after-current') || 
                                             line.classList.contains('first') || 
                                             line.classList.contains('last');
                    if (hasUnwantedClasses) {
                        ['current', 'before-current', 'after-current', 'first', 'last'].forEach(cls => {
                            if (line.classList.contains(cls)) {
                                classesToRemove.push(cls);
                                shouldUpdate = true;
                            }
                        });
                    }
                }
                
                if (shouldUpdate) {
                    linesToUpdate.push({ line, classesToAdd, classesToRemove });
                }
            });
            
            linesToUpdate.forEach(({ line, classesToAdd, classesToRemove }) => {
                classesToRemove.forEach(cls => line.classList.remove(cls));
                classesToAdd.forEach(cls => line.classList.add(cls));
            });

            if (!isLyricsScrolling) {
                requestAnimationFrame(() => {
                    scrollToActiveLyric(activeIndex);
                });
            }
        }
        
        // 滚动到当前活动歌词
        function scrollToActiveLyric(activeIndex) {
            if (currentLyrics.length === 0 || activeIndex < 0) return;
            
            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            if (lyricLines[activeIndex]) {
                const containerHeight = playerLyricsWrapper.clientHeight;
                const lineHeight = lyricLines[activeIndex].offsetHeight;
                const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                
                playerLyricsWrapper.scrollTop = Math.max(0, idealScrollTop);
            }
        }
        
        // 调整歌词偏移量
        function adjustLyrics(offset) {
            lyricsOffset += offset;
            showNotification(`歌词${offset > 0 ? '延后' : '提前'}${Math.abs(offset)}秒 (${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}秒)`, 'info');
            
            updateLyricsOffsetDisplay();
            updateLyricHighlight();
        }
        
        // 重置歌词偏移量
        function resetLyricsOffset() {
            lyricsOffset = 0;
            showNotification('歌词偏移已重置', 'success');
            
            updateLyricsOffsetDisplay();
            updateLyricHighlight();
        }
        
        // 更新歌词偏移量显示
        function updateLyricsOffsetDisplay() {
            if (lyricsOffsetDisplay) {
                lyricsOffsetDisplay.textContent = `${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}`;
                lyricsOffsetDisplay.style.opacity = Math.abs(lyricsOffset) > 0.1 ? '1' : '0';
            }
        }

        // 播放控制
        function togglePlay() {
            if (audioPlayer.src) {
                if (isPlaying) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            } else {
                showNotification('请先选择要播放的歌曲', 'warning');
            }
        }

        function previousSong() {
            if (currentIndex > 0) {
                playSong(currentIndex - 1);
            } else {
                showNotification('已经是第一首歌曲', 'info');
            }
        }

        function nextSong() {
            if (currentIndex < activePlaylist.length - 1) {
                playSong(currentIndex + 1);
            } else {
                if (repeatMode === 1) {
                    playSong(0);
                } else {
                    showNotification('已经是最后一首歌曲', 'info');
                }
            }
        }

        // 进度控制
        function seekTo(event) {
            if (audioPlayer.duration) {
                const rect = event.target.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        }

        function setVolume(value) {
            audioPlayer.volume = value / 100;
            
            const volumeIcon = document.querySelector('.volume-icon');
            if (value == 0) {
                volumeIcon.className = 'fas fa-volume-mute volume-icon';
            } else if (value < 50) {
                volumeIcon.className = 'fas fa-volume-down volume-icon';
            } else {
                volumeIcon.className = 'fas fa-volume-up volume-icon';
            }
        }

        // 格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 通知系统
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' :
                           type === 'error' ? 'rgba(244, 67, 54, 0.9)' :
                           type === 'warning' ? 'rgba(255, 152, 0, 0.9)' :
                           'rgba(33, 150, 243, 0.9)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                font-size: 14px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 音频事件监听
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
            }
            updateLyricHighlight();
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            totalTimeSpan.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            if (repeatMode === 2) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                return;
            }
            
            if (isShuffling) {
                const randomIndex = Math.floor(Math.random() * activePlaylist.length);
                playSong(randomIndex);
                showNotification(`随机播放下一首`, 'info');
                return;
            }
            
            if (currentIndex < activePlaylist.length - 1) {
                playSong(currentIndex + 1);
            } else {
                if (repeatMode === 1) {
                    playSong(0);
                    showNotification('列表循环：从头开始播放', 'info');
                } else {
                    isPlaying = false;
                    updatePlayButton();
                    currentCover.classList.remove('playing');
                    showNotification('播放结束', 'info');
                }
            }
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            updatePlayButton();
            currentCover.classList.add('playing');
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'playing';
            }
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            updatePlayButton();
            currentCover.classList.remove('playing');
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowLeft' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                previousSong();
            } else if (e.code === 'ArrowRight' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                nextSong();
            }
        });

        // 搜索框回车事件
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });

        // 歌单导入功能
        async function importPlaylist() {
            const playlistIdInput = document.getElementById('playlistIdInput');
            const playlistId = playlistIdInput.value.trim();
            
            if (!playlistId) {
                showNotification('请输入歌单ID或链接', 'warning');
                return;
            }
            
            let id = playlistId;
            const match = playlistId.match(/playlist\?id=(\d+)/);
            if (match) {
                id = match[1];
            }
            
            if (savedPlaylists.some(p => p.id === id)) {
                showNotification('该歌单已存在', 'warning');
                return;
            }
            
            try {
                showNotification('正在导入歌单...', 'info');
                
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '',
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    const creator = data.playlist.creator ? {
                        nickname: data.playlist.creator.nickname,
                        avatarUrl: data.playlist.creator.avatarUrl
                    } : null;
                    
                    const playlist = {
                        id: data.playlist.id,
                        name: data.playlist.name,
                        tracks: tracks,
                        cover: data.playlist.coverImgUrl || '',
                        creator: creator,
                        playCount: data.playlist.playCount || 0,
                        description: data.playlist.description || '',
                        tags: data.playlist.tags || [],
                        createTime: new Date().toISOString()
                    };
                    
                    savedPlaylists.push(playlist);
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    displaySavedPlaylists();
                    
                    playlistIdInput.value = '';
                } else {
                    showNotification('无法获取歌单信息，请检查ID是否正确', 'error');
                }
            } catch (error) {
                console.error('导入歌单失败:', error);
            }
        }
        
        // 显示保存的歌单
        function displaySavedPlaylists() {
            const container = document.getElementById('savedPlaylists');
            container.innerHTML = '';
            
            if (savedPlaylists.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>暂无保存的歌单</div></div>';
                return;
            }
            
            savedPlaylists.forEach((playlist, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.onclick = () => playPlaylist(index);
                playlistItem.innerHTML = `
                    <div class="playlist-info">
                        <div class="playlist-name">${playlist.name}</div>
                        <div class="playlist-count">${playlist.tracks.length} 首歌曲</div>
                    </div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" onclick="playPlaylist(${index}); event.stopPropagation();" title="播放歌单">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="updatePlaylist(${index}); event.stopPropagation();" title="更新歌单">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="removePlaylist(${index}); event.stopPropagation();" title="删除歌单">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(playlistItem);
            });
        }
        
        // 播放歌单
        function playPlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            currentPlaylist = playlist.tracks;
            activePlaylist = playlist.tracks;
            currentIndex = -1;
            
            currentPlaylistId = playlist.id;
            
            document.getElementById('resultsTitle').innerHTML = playlist.name;
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'flex';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'flex';
            
            displayPlaylistDetail(playlist);
            
            displaySearchResults(playlist.tracks);
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.classList.remove('search-results-tall');
            
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        // 显示歌单详情
        function displayPlaylistDetail(playlist) {
            document.getElementById('playlistDetail').style.display = 'block';
            
            document.getElementById('playlistCover').src = playlist.cover || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIxMCIvPgo8cGF0aCBkPSJNNTAgNDVMMTAwIDc1TDUwIDEwNVY0NVoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIvPgo8L3N2Zz4=';
            
            document.getElementById('playlistTitle').textContent = playlist.name;
            
            if (playlist.creator) {
                document.getElementById('creatorAvatar').src = playlist.creator.avatarUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = playlist.creator.nickname || '未知创建者';
            } else {
                document.getElementById('creatorAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = '未知创建者';
            }
            
            document.getElementById('playlistPlayCount').textContent = `播放: ${playlist.playCount || 0}次`;
            document.getElementById('playlistTrackCount').textContent = `歌曲: ${playlist.tracks.length}首`;
            
            const descriptionEl = document.getElementById('playlistDescription');
            if (playlist.description) {
                descriptionEl.textContent = playlist.description;
                descriptionEl.style.display = 'block';
            } else {
                descriptionEl.style.display = 'none';
            }
            
            const tagsContainer = document.getElementById('playlistTags');
            tagsContainer.innerHTML = '';
            if (playlist.tags && playlist.tags.length > 0) {
                playlist.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'playlist-tag';
                    tagEl.textContent = tag;
                    tagsContainer.appendChild(tagEl);
                });
            }
        }
        
        // 清除歌单视图
        function clearPlaylistView() {
            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            document.getElementById('playlistDetail').style.display = 'none';
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            `;
            
            resultsContainer.classList.add('search-results-tall');
            
            currentPlaylist = [];
            activePlaylist = [];
            currentIndex = -1;
            currentPlaylistId = null;
            
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        // 删除歌单
        function removePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            if (confirm(`确定要删除歌单 "${playlist.name}" 吗？`)) {
                savedPlaylists.splice(index, 1);
                localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                displaySavedPlaylists();
                showNotification('歌单已删除', 'success');
            }
        }
        
        // 更新歌单
        async function updatePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            try {
                showNotification('正在更新歌单...', 'info');
                
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${playlist.id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '',
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    savedPlaylists[index].tracks = tracks;
                    savedPlaylists[index].name = data.playlist.name;
                    savedPlaylists[index].cover = data.playlist.coverImgUrl || '';
                    savedPlaylists[index].playCount = data.playlist.playCount || 0;
                    savedPlaylists[index].description = data.playlist.description || '';
                    savedPlaylists[index].tags = data.playlist.tags || [];
                    
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    displaySavedPlaylists();
                    
                    let isCurrentPlaylist = false;
                    if (currentPlaylistId === playlist.id) {
                        isCurrentPlaylist = true;
                    }
                    
                    if (isCurrentPlaylist) {
                        currentPlaylist = tracks;
                        activePlaylist = tracks;
                        displaySearchResults(tracks);
                        displayPlaylistDetail(savedPlaylists[index]);
                        document.getElementById('resultsTitle').innerHTML = savedPlaylists[index].name;
                        
                        const resultsContainer = document.getElementById('searchResults');
                        resultsContainer.classList.remove('search-results-tall');
                    }
                    
                    showNotification('歌单更新完成', 'success');
                } else {
                    showNotification('无法获取歌单信息', 'error');
                }
            } catch (error) {
                console.error('更新歌单失败:', error);
                showNotification('更新歌单失败', 'error');
            }
        }
        
        // 计算player-section中除歌词容器外其他元素的总高度
        function calculateOtherElementsHeight(playerSection, lyricsContainer) {
            let otherElementsHeight = 0;
            const playerChildren = playerSection.children;
            
            for (let i = 0; i < playerChildren.length; i++) {
                const child = playerChildren[i];
                if (child !== lyricsContainer) {
                    const computedStyle = window.getComputedStyle(child);
                    const marginTop = parseFloat(computedStyle.marginTop) || 0;
                    const marginBottom = parseFloat(computedStyle.marginBottom) || 0;
                    otherElementsHeight += child.offsetHeight + marginTop + marginBottom;
                }
            }
            
            const playerComputedStyle = window.getComputedStyle(playerSection);
            const playerPaddingTop = parseFloat(playerComputedStyle.paddingTop) || 0;
            const playerPaddingBottom = parseFloat(playerComputedStyle.paddingBottom) || 0;
            otherElementsHeight += playerPaddingTop + playerPaddingBottom;
            
            return otherElementsHeight;
        }
        
        // 初始化高度同步监听器
        function initHeightSync() {
            if (heightSyncInitialized) return;
            
            if (window.innerWidth <= 768) return;
            
            const contentSection = document.querySelector('.content-section');
            const playerSection = document.querySelector('.player-section');
            const lyricsContainer = document.getElementById('playerLyricsContainer');
            
            if (!contentSection || !playerSection || !lyricsContainer) return;
            
            initialContentHeight = contentSection.offsetHeight;
            initialPlayerHeight = playerSection.offsetHeight;
            
            const initialOtherElementsHeight = calculateOtherElementsHeight(playerSection, lyricsContainer);
            
            if (window.ResizeObserver) {
                contentResizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target === contentSection) {
                            const newContentHeight = entry.contentRect.height;
                            const contentHeightDiff = newContentHeight - initialContentHeight;
                            
                            const targetPlayerHeight = initialPlayerHeight + contentHeightDiff;
                            const idealLyricsHeight = targetPlayerHeight - initialOtherElementsHeight;
                            const newLyricsHeight = Math.max(initialLyricsHeight, idealLyricsHeight);
                            
                            lyricsContainer.style.height = `${newLyricsHeight}px`;
                        }
                    }
                });
                
                contentResizeObserver.observe(contentSection);
                heightSyncInitialized = true;
            }
        }
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('https://music.xkabctt.serv00.net/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        // 新增：加载自定义播放列表
        loadCustomPlaylist();
        // 初始化
        setVolume(80);
        displaySavedPlaylists();
        updateCustomPlaylistUI();
        
        window.addEventListener('load', () => {
            setTimeout(initHeightSync, 100);
        });
        
        window.addEventListener('resize', () => {
            heightSyncInitialized = false;
            setTimeout(initHeightSync, 100);
        });
    </script>
</body>
</html>