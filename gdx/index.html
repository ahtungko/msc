<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="iMusic" />
    <meta name="theme-color" content="#000000" >
    <meta name="google" content="notranslate" >
    <title>在线音乐播放器</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #0c0c0c;
            color: #fff;
            overflow-x: hidden;
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -2;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 顶部导航 */
        .navbar {
            background: #1a1a1a; /* Use a solid dark color */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0; /* 防止logo被压缩 */
        }

        .logo i {
            color: #ff6b6b;
            font-size: 28px;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 40px;
            position: relative;
        }

        .search-wrapper {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .search-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            outline: none;
            min-width: 0; /* 允许输入框收缩 */
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .source-select {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 12px 15px;
            outline: none;
            cursor: pointer;
            display: block; /* 默认显示 */
        }

        .source-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        .search-btn {
            background: #ff6b6b;
            border: none;
            color: #fff;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px; /* 确保按钮不会太小 */
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .search-btn:hover {
            background: #ff5252;
        }

        /* 主要内容区域 - 关键修复：添加容器宽度控制 */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            display: flex;
            gap: 25px;
            min-height: calc(100vh - 200px);
            /* 关键修复：防止子元素影响容器宽度 */
            width: 100%;
            box-sizing: border-box;
        }

        /* 搜索结果区域 */
        .content-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 0;
            overflow: hidden;
            /* 关键修复：防止内容溢出影响布局 */
            max-width: 100%;
            /* 使高度与 player-section 一致 */
            display: flex;
            flex-direction: column;
            flex: 1;
            /* 确保不会因为内容变化而影响宽度 */
            width: 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            /* 确保子元素不会被压缩 */
            flex-wrap: nowrap;
        }
        
        .playlist-tag-indicator {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            padding: 2px 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #resultsTitle {
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
            padding: 2px 4px;
            transition: all 0.3s ease;
        }

        .search-results {
            max-height: 250px; /* 限制最大高度 */
            min-height: 250px; /* 确保最小高度 */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            /* 使内容区域填充剩余空间 */
            flex: 1;
        }

        /* 当显示搜索结果而不是歌单时，设置单独的max-height */
        .search-results.search-results-tall {
            max-height: 600px;
        }

        /* 当显示搜索结果而不是歌单时，设置单独的max-height */
        .search-results:not(:has(.playlist-tag-indicator:visible)) {
            max-height: 600px;
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-results::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
            /* 关键修复：防止内容溢出 */
            max-width: 100%;
        }

        .song-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .song-item:hover::before {
            left: 100%;
        }

        .song-item.active {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1));
            border: 1px solid rgba(255, 107, 107, 0.5);
        }

        .song-index {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0; /* 防止被压缩 */
        }

        .song-item.active .song-index {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: #fff;
        }

        .song-info {
            flex: 1;
            min-width: 0; /* 允许收缩 */
        }

        .song-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 播放器区域 */
        .player-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* 移除 position: sticky 以确保高度一致 */
            display: flex;
            flex-direction: column;
            /* 使高度与 content-section 一致 */
            height: auto;
            min-height: 100%;
            /* 关键修复：防止内容溢出影响布局 */
            max-width: 100%;
            box-sizing: border-box;
            /* 使宽度与 content-section 一致 */
            flex: 1;
            /* 确保不会因为内容变化而影响宽度 */
            width: 0;
        }
        
        /* 播放器歌词显示 - 关键修复：完全控制宽度 */
        .player-lyrics-container {
            margin: 20px 0;
            height: 150px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(5px);
            /* 关键修复：固定宽度并防止溢出 */
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            /* 防止内容溢出 */
            overflow: hidden;
            /* 添加过渡动画使高度变化更平滑 */
            transition: height 0.15s ease; /* 缩短过渡时间使变化更快 */
        }
        
        .player-lyrics-wrapper {
            position: relative;
            height: 100%;
            overflow-y: auto;
            display: block;
            /* 关键修复：隐藏滚动条但保持功能 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            /* 防止内容溢出 */
            overflow-x: hidden;
        }
        
        /* 动态调整歌词容器高度的类 */
        .lyrics-auto-height {
            height: auto;
            min-height: 150px;
        }
        
        /* 隐藏webkit滚动条 */
        .player-lyrics-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .player-lyrics-list {
            position: relative;
            width: 100%;
            /* 关键修复：防止列表宽度受内容影响 */
            table-layout: fixed;
        }
        
        .player-lyric-line {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            padding: 0 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            /* 关键修复：确保行宽度固定，防止溢出 */
            width: 100%;
            box-sizing: border-box;
            /* 防止长文本影响布局 */
            max-width: 100%;
            /* 确保文本不会因为放大而溢出 */
            transform-origin: center;
            /* 调整行间距 */
            margin: 3px 0;
        }
        
        .player-lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            height: auto;
            min-height: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: clip;
            /* 限制最大宽度 */
            max-width: 100%;
            /* 调整行间距 */
            margin: 3px 0;
        }
        
        .player-lyric-line.current {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            /* 移除字号放大以避免宽度问题 */
            font-size: 14px;
            /* 增加与上下歌词的间距 */
            margin: 6px 0;
        }
        
        .player-lyric-line.current.long-text {
            font-size: 14px;
            /* 增加与上下歌词的间距 */
            margin: 6px 0;
        }
        
        .player-lyric-line.before-current,
        .player-lyric-line.after-current {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 模糊效果 */
        .player-lyric-line.first,
        .player-lyric-line.last {
            color: rgba(255, 255, 255, 0.3);
            filter: blur(1px);
        }
        
        /* 歌词校准控制 */
        .lyrics-adjust-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        /* 偏移量显示 */
        .lyrics-offset-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .player-lyrics-container:hover .lyrics-offset-display {
            opacity: 1;
        }
        
        .lyrics-adjust-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .lyrics-adjust-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .current-song {
            text-align: center;
            margin-bottom: 25px;
        }

        .current-cover-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .current-cover {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            border: 6px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .current-cover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        .current-cover::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        .current-cover.playing {
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .current-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            /* 防止标题过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            /* 防止艺术家信息过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 播放控制 */
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;   
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn.small {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }

        .play-btn {
            width: 65px;
            height: 65px;
            font-size: 28px;
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff4444);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
        }

        /* 进度条 */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 音量控制 */
        .volume-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .volume-icon {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            flex-shrink: 0; /* 防止图标被压缩 */
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #ff6b6b;
            border-radius: 50%;
            cursor: pointer;
        }

        /* 音质选择 */
        .quality-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            flex-shrink: 0; /* 防止标签被压缩 */
        }

        .quality-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            outline: none;
            cursor: pointer;
            font-size: 14px;
            /* 防止选择框过宽 */
            max-width: 150px;
        }

        .quality-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        /* 下载区域 */
        .download-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            /* 防止按钮内容过宽 */
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .download-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 歌曲操作按钮 */
        .song-actions {
            display: flex;
            gap: 8px;
            margin-right: 15px;
            flex-shrink: 0; /* 防止按钮组被压缩 */
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            transform: scale(1.1);
        }

        /* 歌词容器 */
        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            padding-right: 10px;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .lyric-line {
            padding: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 6px;
            padding-left: 10px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
            /* 防止歌词过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .lyric-line.active {
            color: #ff6b6b;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.02);
            border-left: 3px solid #ff6b6b;
        }

        /* 歌单导入区域 */
        .playlist-import {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        /* 歌单详情 */
        .playlist-detail {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
            /* 确保不会占用太多空间 */
            flex-shrink: 0;
        }
        
        .playlist-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .playlist-cover {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0; /* 防止图片被压缩 */
        }
        
        .playlist-info-container {
            flex: 1;
            min-width: 0; /* 允许收缩 */
        }
        
        .playlist-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            /* 允许标题换行以避免被截断 */
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-creator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .creator-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0; /* 防止头像被压缩 */
        }
        
        .creator-name {
            font-weight: 500;
            /* 防止名字过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .playlist-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        
        .playlist-description {
            margin-bottom: 15px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            /* 允许描述换行显示 */
            white-space: normal;
            word-wrap: break-word;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .playlist-tag {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            /* 防止标签过长 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .import-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .import-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            outline: none;
            font-size: 14px;
            /* 防止输入框过宽 */
            min-width: 0;
        }

        .import-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .import-btn {
            padding: 12px 20px;
            background: #ff6b6b;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .import-btn:hover {
            background: #ff5252;
        }

        .saved-playlists {
            margin-top: 20px;
        }

        .playlist-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* 防止歌单项目过宽 */
            max-width: 100%;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item .playlist-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .playlist-item .playlist-name {
            font-weight: 500;
            /* 允许歌单名称换行以避免挤出操作按钮 */
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            /* 限制最大行数 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-item .playlist-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0; /* 防止计数被压缩 */
            /* 限制文本长度 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .playlist-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0; /* 防止按钮组被压缩 */
        }

        .playlist-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .playlist-action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* 加载和错误状态 */
        .loading, .error, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading i, .error i, .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .loading i {
            animation: spin 1s linear infinite;
            color: #ff6b6b;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error i {
            color: #ff5252;
        }

        .empty-state i {
            color: rgba(255, 255, 255, 0.4);
        }

        /* 响应式设计 */
        @media (max-width: 1400px) {
            .main-container {
                gap: 20px;
                max-width: 1200px;
            }
            
            .content-section, .player-section {
                /* 在中等屏幕尺寸下重置宽度 */
                width: auto;
            }
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                /* 关键修复：确保容器不会因为内容而变宽 */
                width: 100%;
                max-width: 100%;
            }
            
            .nav-container {
                padding: 0 20px;
            }
            
            .search-container {
                margin: 0 20px;
            }
            
            .player-section {
                position: static;
                min-height: auto;
                height: auto;
            }
            
            /* 关键修复：确保所有子元素不会突破容器 */
            .content-section, .player-section {
                max-width: 100%;
                overflow: hidden;
                /* 在小屏幕尺寸下重置宽度 */
                width: auto;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
                padding: 0 15px;
            }
            
            .search-container {
                margin: 0;
                max-width: none;
                width: 100%;
                padding: 0;
            }
            
            .search-wrapper {
                width: 100%;
            }
            
            /* 在移动端显示来源选择 */
            .source-select {
                display: block;
            }
            
            /* 调整搜索按钮在移动端的显示 */
            .search-btn {
                padding: 12px 15px;
                min-width: 45px;
            }
            
            .search-btn i {
                font-size: 16px;
            }
            
            .current-cover {
                width: 180px;
                height: 180px;
            }
            
            .player-controls {
                gap: 15px;
            }
            
            .download-container {
                grid-template-columns: 1fr;
            }
            
            .import-form {
                flex-direction: column;
            }
            
            .import-btn {
                justify-content: center;
            }
            
            .playlist-header {
                flex-direction: column;
            }
            
            .playlist-cover {
                width: 100%;
                height: auto;
                aspect-ratio: 1/1;
            }
            
            /* 移动端歌词容器优化 */
            .player-lyrics-container {
                height: 120px; /* 固定高度以显示五行歌词 */
                padding: 8px;
                /* 关键修复：确保容器宽度固定 */
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                transition: none; /* 移动端禁用过渡动画 */
            }
            
            .player-lyric-line {
                font-size: 13px;
                height: 26px;
                line-height: 26px;
                padding: 0 10px;
                /* 防止文本溢出 */
                max-width: 100%;
                box-sizing: border-box;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                /* 移除字号放大以避免宽度问题 */
                font-size: 13px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
            
            .player-lyric-line.long-text {
                font-size: 11px;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current.long-text {
                font-size: 13px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
            
            .playlist-tag-indicator {
                font-size: 12px;
                padding: 2px 10px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                /* 修复移动端显示问题 */
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 20px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* 增加移动端搜索结果区域的高度 */
            .search-results {
                max-height: 380px; /* 增加最大高度 */
                min-height: 380px; /* 增加最小高度 */
            }
            
            /* 当显示搜索结果而不是歌单时，设置单独的max-height */
            .search-results.search-results-tall {
                max-height: 600px;
            }
        }

        /* 针对非常小的屏幕优化 */
        @media (max-width: 480px) {
            .nav-container {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo i {
                font-size: 24px;
            }
            
            .search-input {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .source-select {
                padding: 10px 10px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 10px 12px;
            }
            
            .content-section, .player-section, .playlist-import {
                padding: 20px 15px;
            }
            
            .song-item {
                padding: 12px 15px;
            }
            
            .song-name {
                font-size: 15px;
            }
            
            .song-artist {
                font-size: 13px;
            }
            
            .section-title {
                font-size: 18px;
                /* 确保子元素不会被压缩 */
                flex-wrap: nowrap;
            }
            
            .playlist-tag-indicator {
                font-size: 11px;
                padding: 1px 8px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                /* 修复小屏幕显示问题 */
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 18px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* 移动端歌单项目优化 */
            .playlist-item .playlist-name {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .playlist-item .playlist-count {
                font-size: 12px;
            }
            

            .player-lyric-line {
                font-size: 12px;
                height: 24px;
                line-height: 24px;
                /* 调整行间距 */
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                /* 移除字号放大以避免宽度问题 */
                font-size: 12px;
                /* 增加与上下歌词的间距 */
                margin: 6px 0;
            }
        }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* 滚动歌词样式 */
        .lyrics-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            padding: 4px 0;
        }

        .control-btn.active {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .fa-repeat-1::before {
            content: "\f36a";
        }

        @media (max-width: 768px) {
            .logo {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>

    <nav class="navbar" role="navigation" aria-label="主导航">
        <div class="nav-container">
            <div class="logo" role="banner">
                <i class="fas fa-music" aria-hidden="true"></i>
                <span></span>
            </div>
            
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑..." id="searchInput" aria-label="搜索音乐">
                    <select class="source-select" id="sourceSelect" aria-label="选择音乐来源">
                        <option value="netease">网易云音乐</option>
                        <option value="kuwo">酷我音乐</option>
                        <option value="joox">JOOX</option>
                        <option value="ximalaya">喜马拉雅</option>
                    </select>
                    <button class="search-btn" onclick="searchMusic()" aria-label="搜索">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-list-music"></i>
                <span class="playlist-tag-indicator" style="display: none;">歌单</span>
                <span id="resultsTitle">搜索结果</span>
                <button id="clearPlaylistBtn" class="action-btn" style="margin-left: auto; display: none;" onclick="clearPlaylistView()" title="清除歌单视图">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            <div class="search-results" id="searchResults">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            </div>

            <div class="playlist-detail" id="playlistDetail">
                <div class="playlist-header">
                    <img class="playlist-cover" id="playlistCover" src="" alt="歌单封面">
                    <div class="playlist-info-container">
                        <h2 class="playlist-title" id="playlistTitle"></h2>
                        <div class="playlist-creator">
                            <img class="creator-avatar" id="creatorAvatar" src="" alt="创建者头像">
                            <span class="creator-name" id="creatorName"></span>
                        </div>
                        <div class="playlist-stats">
                            <span id="playlistPlayCount"></span>
                            <span id="playlistTrackCount"></span>
                        </div>
                        <div class="playlist-tags" id="playlistTags">
                            </div>
                    </div>
                </div>
                <div class="playlist-description" id="playlistDescription"></div>
            </div>
            
            <div class="playlist-import">
                <h2 class="section-title">
                    <i class="fas fa-folder-plus"></i>
                    导入网易云歌单
                </h2>
                <div class="import-form">
                    <input type="text" class="import-input" id="playlistIdInput" placeholder="粘贴 ID 或 链接">
                    <button class="import-btn" onclick="importPlaylist()">
                        <i class="fas fa-download"></i>
                        <span>导入</span>
                    </button>
                </div>
                <div class="saved-playlists" id="savedPlaylists">
                    </div>
            </div>
        </div>

        <div class="player-section">
            <div class="current-song">
                <div class="current-cover-container">
                    <img class="current-cover" id="currentCover" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=" alt="专辑封面">
                </div>
                <div class="current-info">
                    <h3 id="currentTitle">未选择歌曲</h3>
                    <p id="currentArtist">请搜索并选择要播放的歌曲</p>
                </div>
            </div>

            <div class="player-lyrics-container" id="playerLyricsContainer">
                <div class="lyrics-offset-display" id="lyricsOffsetDisplay">±0.0</div>
                <div class="player-lyrics-wrapper" id="playerLyricsWrapper">
                    <div class="player-lyrics-list" id="playerLyricsList"></div>
                </div>

            </div>
                  <div class="lyrics-adjust-controls">
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(0.5)" title="歌词延后0.5秒" aria-label="歌词延后0.5秒">←</button>
                    <button class="lyrics-adjust-btn" onclick="resetLyricsOffset()" title="重置歌词偏移" aria-label="重置歌词偏移">↺</button>
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(-0.5)" title="歌词提前0.5秒" aria-label="歌词提前0.5秒">→</button>
                </div>
            <div class="player-controls">
                <button class="control-btn small" onclick="toggleRepeat()" aria-label="重复播放" id="repeatBtn">
                    <i class="fas fa-repeat" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="previousSong()" aria-label="上一首">
                    <i class="fas fa-step-backward" aria-hidden="true"></i>
                </button>
                <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()" aria-label="播放/暂停">
                    <i class="fas fa-play" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="nextSong()" aria-label="下一首">
                    <i class="fas fa-step-forward" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="toggleShuffle()" aria-label="随机播放" id="shuffleBtn">
                    <i class="fas fa-shuffle" aria-hidden="true"></i>
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <div class="quality-container">
                <div class="quality-label">
                    <i class="fas fa-music"></i>
                    <span>音质</span>
                </div>
                <select class="quality-select" id="qualitySelect">
                    <option value="128">标准 128K</option>
                    <option value="192">较高 192K</option>
                    <option value="320" selected>高品质 320K</option>
                    <option value="740">无损 FLAC</option>
                    <option value="999">Hi-Res</option>
                </select>
            </div>

            <div class="volume-container">
                <i class="fas fa-volume-up volume-icon"></i>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" onchange="setVolume(this.value)">
            </div>

            <div class="download-container">
                <button class="download-btn" onclick="downloadCurrentSong()" id="downloadSongBtn" disabled>
                    <i class="fas fa-download"></i>
                    <span>下载音乐</span>
                </button>
                <button class="download-btn" onclick="downloadCurrentLyric()" id="downloadLyricBtn" disabled>
                    <i class="fas fa-file-text"></i>
                    <span>下载歌词</span>
                </button>
            </div>

            <audio id="audioPlayer" preload="metadata"></audio>
        </div>
    </div>

    <script>
        const API_BASE = 'https://music-api.gdstudio.xyz/api.php';
        let currentPlaylist = [];
        let currentIndex = -1;
        let currentPlaylistId = null; // 当前播放的歌单ID
        let currentLyrics = [];
        let isPlaying = false;
        let savedPlaylists = JSON.parse(localStorage.getItem('savedPlaylists')) || [];
        let repeatMode = 0; // 0: No repeat, 1: Repeat all, 2: Repeat one
        let isShuffling = false;
        let originalPlaylist = [];
        let shuffledPlaylist = [];
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const totalTimeSpan = document.getElementById('totalTime');
        const playerLyricsList = document.getElementById('playerLyricsList');
        const playerLyricsWrapper = document.getElementById('playerLyricsWrapper');
        const playerLyricsContainer = document.getElementById('playerLyricsContainer');
        const lyricsOffsetDisplay = document.getElementById('lyricsOffsetDisplay');
        const currentCover = document.getElementById('currentCover');
        
        // 歌词偏移量（用于手动校准）
        let lyricsOffset = 0;
        let currentSongId = null;
        
        // 歌词滚动相关变量
        let isLyricsScrolling = false;
        let lyricsScrollTimeout = null;
        let lastScrollTime = 0;
        
        // 高度同步相关变量
        let initialContentHeight = 0;
        let initialLyricsHeight = 150; // 初始歌词容器高度
        let initialPlayerHeight = 0; // 初始player-section高度
        let contentResizeObserver = null;
        let heightSyncInitialized = false;

        // 搜索音乐
        async function searchMusic() {
            const keyword = document.getElementById('searchInput').value.trim();
            const source = document.getElementById('sourceSelect').value;
            
            if (!keyword) {
                showNotification('请输入搜索关键词', 'warning');
                return;
            }

            // 重置标题显示
            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            // 隐藏歌单标签
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            // 隐藏歌单详情区域
            document.getElementById('playlistDetail').style.display = 'none';
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>正在搜索音乐...</div>
                </div>
            `;
            
            // 为搜索结果添加特殊样式类
            resultsContainer.classList.add('search-results-tall');

            try {
                const response = await fetch(`${API_BASE}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=30`);
                const data = await response.json();

                if (data && data.length > 0) {
                    currentPlaylist = data;
                    currentPlaylistId = null; // 重置当前播放的歌单ID
                    displaySearchResults(data);
                    // 重新初始化高度同步
                    setTimeout(() => {
                        heightSyncInitialized = false;
                        initHeightSync();
                    }, 100);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>未找到相关歌曲，请尝试其他关键词</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <i class="fas fa-wifi"></i>
                        <div>网络连接失败，请检查网络后重试</div>
                    </div>
                `;
            }
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const repeatBtn = document.getElementById('repeatBtn');
            const icon = repeatBtn.querySelector('i');

            // Remove any active state
            repeatBtn.classList.remove('active');

            if (repeatMode === 1) {
                // Repeat All
                repeatBtn.classList.add('active');
                icon.className = 'fas fa-repeat';
                showNotification('已开启列表循环', 'info');
            } else if (repeatMode === 2) {
                // Repeat One
                repeatBtn.classList.add('active');
                // Change the icon to something that is supported
                icon.className = 'fas fa-redo'; 
                showNotification('已开启单曲循环', 'info');
            } else {
                // No Repeat
                icon.className = 'fas fa-repeat';
                showNotification('已关闭循环', 'info');
            }
        }

        function toggleShuffle() {
            isShuffling = !isShuffling;
            const shuffleBtn = document.getElementById('shuffleBtn');
            shuffleBtn.classList.toggle('active', isShuffling);
            
            if (isShuffling) {
                // Save the current order before shuffling
                originalPlaylist = [...currentPlaylist];
                shuffledPlaylist = shuffleArray([...currentPlaylist]);
                currentPlaylist = shuffledPlaylist;
                showNotification('已开启随机播放', 'info');
            } else {
                // Restore the original order
                currentPlaylist = originalPlaylist;
                showNotification('已关闭随机播放', 'info');
            }
            
            // Update the UI to reflect the new order
            displaySearchResults(currentPlaylist);
            // Find the new index of the current song
            if (currentIndex !== -1) {
                const currentSongId = originalPlaylist[currentIndex].id;
                const newIndex = currentPlaylist.findIndex(song => song.id === currentSongId);
                currentIndex = newIndex;
                updateActiveItem();
            }
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 获取专辑图片URL
        async function getAlbumCoverUrl(song, size = 300) {
            // 对于歌单中的歌曲，直接使用picUrl字段
            if (song.picUrl) {
                return song.picUrl;
            }
            
            // 对于搜索结果中的歌曲，使用原来的pic_id获取封面图片
            const picId = song.pic_id || song.id;
            
            if (!picId) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHZpZXdCb3g9IjAgMCA1NSA1NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU1IiBoZWlnaHQ9IjU1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSI4Ii8+CjxwYXRoIGQ9Ik0yNy41IDE4TDM1IDI3LjVIMzBWMzdIMjVWMjcuNUgyMEwyNy41IDE4WiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
            }

            try {
                const response = await fetch(`${API_BASE}?types=pic&source=${song.source}&id=${picId}&size=${size}`);
                const data = await response.json();
                
                if (data && data.url) {
                    return data.url;
                }
            } catch (error) {
                console.error('获取专辑图失败:', error);
            }
            
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHZpZXdCb3g9IjAgMCA1NSA1NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU1IiBoZWlnaHQ9IjU1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSI4Ii8+CjxwYXRoIGQ9Ik0yNy41IDE4TDM1IDI3LjVIMzBWMzdIMjVWMjcuNUgyMEwyNy41IDE4WiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
        }

        // 显示搜索结果
        async function displaySearchResults(songs) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            for (let index = 0; index < songs.length; index++) {
                const song = songs[index];
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.onclick = () => playSong(index);

                songItem.innerHTML = `
                    <div class="song-index" aria-hidden="true">${(index + 1).toString().padStart(2, '0')}</div>
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}</div>
                    </div>
                    <div class="song-actions">
                        <button class="action-btn" onclick="downloadSong(${index})" title="下载音乐" aria-label="下载音乐 ${song.name}">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn" onclick="downloadLyric(${index})" title="下载歌词" aria-label="下载歌词 ${song.name}">
                            <i class="fas fa-file-text" aria-hidden="true"></i>
                        </button>
                    </div>
                `;

                resultsContainer.appendChild(songItem);
            }
        }

        // 播放歌曲
        async function playSong(index) {
            if (index < 0 || index >= currentPlaylist.length) return;

            currentIndex = index;
            const song = currentPlaylist[index];

            // 更新UI
            await updateCurrentSongInfo(song);
            updateActiveItem();
            
            // 重置歌词偏移量
            lyricsOffset = 0;
            currentSongId = song.id;

            try {
                showNotification('正在加载音乐...', 'info');
                
                // 获取当前选择的音质
                const quality = document.getElementById('qualitySelect').value;
                
                // 获取音乐URL
                const urlResponse = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const urlData = await urlResponse.json();

                if (urlData && urlData.url) {
                    audioPlayer.src = urlData.url;
                    audioPlayer.load();
                    
                    // 获取歌词
                    loadLyrics(song);
                    
                    // 启用下载按钮
                    document.getElementById('downloadSongBtn').disabled = false;
                    document.getElementById('downloadLyricBtn').disabled = false;
                    
                    // 自动播放
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButton();
                            currentCover.classList.add('playing');
                            showNotification(`开始播放 (${getQualityText(urlData.br || quality)})`, 'success');
                        }).catch(error => {
                            console.error('播放失败:', error);
                            showNotification('播放失败，请尝试其他歌曲', 'error');
                        });
                    }

                    // *** MediaSession API 的核心集成部分 ***
                    // 确保浏览器支持 MediaSession API
                    if ('mediaSession' in navigator) {
                        // 1. 设置媒体元数据
                        const artworkUrl = await getAlbumCoverUrl(song, 500);
                        //console.log(artworkUrl);
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: song.name,
                            artist: Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist,
                            album: song.album,
                            artwork: [
                                { src: artworkUrl, sizes: '512x512', type: 'image/jpeg' },
                            ]
                        });

                        // 2. 设置播放操作处理函数
                        navigator.mediaSession.setActionHandler('play', () => {
                            // 当系统发出“播放”指令时，调用你的播放函数
                            togglePlay();
                        });
                        navigator.mediaSession.setActionHandler('pause', () => {
                            // 当系统发出“暂停”指令时，调用你的暂停函数
                            togglePlay();
                        });

                        //(可选) 设置快进/快退操作
                        // navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                        //     const seekTime = details.seekOffset || 10;
                        //     audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - seekTime);
                        // });
                        // navigator.mediaSession.setActionHandler('seekforward', (details) => {
                        //     const seekTime = details.seekOffset || 10;
                        //     audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + seekTime);
                        // });

                        navigator.mediaSession.setActionHandler('nexttrack', () => {
                            // 当系统发出“下一曲”指令时，调用你的下一曲函数
                            nextSong();
                        });
                        navigator.mediaSession.setActionHandler('previoustrack', () => {
                            // 当系统发出“上一曲”指令时，调用你的上一曲函数
                            previousSong();
                        });

                        
                        
                    }
                } else {
                    showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
                }
            } catch (error) {
                console.error('播放失败:', error);
                showNotification('播放失败，请检查网络连接', 'error');
            }
        }

        // 获取音质文本
        function getQualityText(br) {
            const qualityMap = {
                '128': '标准音质',
                '192': '较高音质',
                '320': '高品质',
                '740': '无损音质',
                '999': 'Hi-Res音质'
            };
            return qualityMap[br] || `${br}K`;
        }

        // 下载当前播放的歌曲
        async function downloadCurrentSong() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载的歌曲', 'warning');
                return;
            }
            
            const song = currentPlaylist[currentIndex];
            await downloadSong(currentIndex);
        }

        // 下载当前播放的歌词
        async function downloadCurrentLyric() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载歌词的歌曲', 'warning');
                return;
            }
            
            await downloadLyric(currentIndex);
        }

        // 下载歌曲
        async function downloadSong(index) {
            const song = currentPlaylist[index];
            const quality = document.getElementById('qualitySelect').value;
            
            try {
                showNotification('正在获取下载链接...', 'info');
                
                const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const data = await response.json();
                
                if (data && data.url) {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = data.url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.mp3`;
                    link.target = '_blank';
                    
                    // 触发下载
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('开始下载音乐文件', 'success');
                } else {
                    showNotification('无法获取下载链接', 'error');
                }
            } catch (error) {
                console.error('下载失败:', error);
                showNotification('下载失败，请稍后重试', 'error');
            }
        }

        // 下载歌词
        async function downloadLyric(index) {
            const song = currentPlaylist[index];
            
            try {
                showNotification('正在获取歌词...', 'info');
                
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();
                
                if (data && data.lyric) {
                    // 创建歌词文件内容
                    let lyricContent = `歌曲：${song.name}\n`;
                    lyricContent += `歌手：${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}\n`;
                    lyricContent += `专辑：${song.album}\n`;
                    lyricContent += `来源：${song.source}\n\n`;
                    lyricContent += data.lyric;
                    
                    if (data.tlyric) {
                        lyricContent += '\n=== 翻译歌词 ===\n';
                        lyricContent += data.tlyric;
                    }
                    
                    // 创建Blob并下载
                    const blob = new Blob([lyricContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.lrc`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(url);
                    showNotification('歌词下载完成', 'success');
                } else {
                    showNotification('该歌曲暂无歌词', 'warning');
                }
            } catch (error) {
                console.error('下载歌词失败:', error);
                showNotification('下载歌词失败，请稍后重试', 'error');
            }
        }

        // 音质改变时重新加载当前歌曲
        document.getElementById('qualitySelect').addEventListener('change', () => {
            if (currentIndex !== -1 && audioPlayer.src) {
                const currentTime = audioPlayer.currentTime;
                const wasPlaying = isPlaying;
                
                playSong(currentIndex).then(() => {
                    // 恢复播放位置
                    audioPlayer.currentTime = currentTime;
                    if (!wasPlaying) {
                        audioPlayer.pause();
                    }
                });
            }
        });

        // 更新当前歌曲信息
        async function updateCurrentSongInfo(song) {
            document.getElementById('currentTitle').textContent = song.name;
            document.getElementById('currentArtist').textContent =
                `${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}`;

            // 获取专辑图片URL
            const coverUrl = await getAlbumCoverUrl(song, 500);
            currentCover.src = coverUrl;
        }

        // 更新活跃项目
        function updateActiveItem() {
            document.querySelectorAll('.song-item').forEach((item, index) => {
                item.classList.toggle('active', index === currentIndex);
            });
        }

        // 更新播放按钮
        function updatePlayButton() {
            const icon = playBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        // 加载歌词
        async function loadLyrics(song) {
            // 重置歌词偏移量
            lyricsOffset = 0;
            currentSongId = song.id;
            
            // 更新偏移量显示
            updateLyricsOffsetDisplay();
            
            try {
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();

                if (data && data.lyric) {
                    parseLyrics(data.lyric);
                } else {
                    displayPlayerLyrics([]);
                    currentLyrics = [];
                }
            } catch (error) {
                console.error('获取歌词失败:', error);
                displayPlayerLyrics([]);
                currentLyrics = [];
            }
        }

        // 解析LRC歌词
        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            currentLyrics = [];

            lines.forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const text = match[4].trim();

                    if (text) {
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        currentLyrics.push({ time, text });
                    }
                }
            });

            currentLyrics.sort((a, b) => a.time - b.time);
            displayPlayerLyrics(currentLyrics);
            
            // 初始化歌词滚动事件监听器
            initLyricsScrollListeners();
        }

        // 显示播放器区域的多行歌词
        function displayPlayerLyrics(lyrics) {
            playerLyricsList.innerHTML = '';
            
            if (lyrics.length === 0) {
                playerLyricsList.innerHTML = '<div class="player-lyric-line empty">暂无歌词</div>';
                return;
            }
            
            // 创建歌词行
            for (let i = 0; i < lyrics.length; i++) {
                const lyricLine = document.createElement('div');
                lyricLine.className = 'player-lyric-line';
                lyricLine.textContent = lyrics[i].text;
                lyricLine.dataset.time = lyrics[i].time;
                
                // 检查歌词长度，如果过长则添加long-text类
                if (lyrics[i].text.length > 30) {
                    lyricLine.classList.add('long-text');
                }
                
                playerLyricsList.appendChild(lyricLine);
            }
        }

        // 初始化歌词滚动事件监听器
        function initLyricsScrollListeners() {
            // 清除之前的事件监听器
            playerLyricsWrapper.removeEventListener('wheel', handleLyricsScroll);
            playerLyricsWrapper.removeEventListener('click', handleLyricClick);
            
            // 添加鼠标滚轮事件监听
            playerLyricsWrapper.addEventListener('wheel', handleLyricsScroll, { passive: false });
            
            // 添加点击事件监听
            playerLyricsWrapper.addEventListener('click', handleLyricClick);
        }

        // 处理歌词滚动事件
        function handleLyricsScroll(e) {
            // 阻止默认的滚动行为
            e.preventDefault();
            
            // 根据滚轮方向滚动歌词容器
            playerLyricsWrapper.scrollTop += e.deltaY;
            
            // 标记正在滚动
            isLyricsScrolling = true;
            lastScrollTime = Date.now();
            
            // 清除之前的定时器
            if (lyricsScrollTimeout) {
                clearTimeout(lyricsScrollTimeout);
            }
            
            // 3秒后自动复位
            lyricsScrollTimeout = setTimeout(() => {
                isLyricsScrolling = false;
                resetLyricsPosition();
            }, 3000);
        }

        // 处理歌词点击事件
        function handleLyricClick(e) {
            // 查找被点击的歌词行
            let target = e.target;
            while (target && !target.classList.contains('player-lyric-line')) {
                target = target.parentElement;
            }
            
            // 如果点击的是歌词行
            if (target && target.classList.contains('player-lyric-line')) {
                // 获取歌词时间
                const time = parseFloat(target.dataset.time);
                
                // 如果有有效的时间数据
                if (!isNaN(time)) {
                    // 设置播放器时间
                    audioPlayer.currentTime = time;
                    
                    // 显示通知
                    showNotification(`已跳转到 ${formatTime(time)}`, 'success');
                    
                    // 停止滚动复位定时器
                    if (lyricsScrollTimeout) {
                        clearTimeout(lyricsScrollTimeout);
                    }
                    
                    // 重置滚动状态
                    isLyricsScrolling = false;
                    
                    // 立即更新歌词高亮
                    updateLyricHighlight();
                }
            }
        }

        // 重置歌词位置到当前播放位置
        function resetLyricsPosition() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset;
            let activeIndex = -1;

            // 找到当前应该高亮的歌词
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            
            // 如果找到了当前歌词，滚动到该位置
            if (activeIndex >= 0) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                if (lyricLines[activeIndex]) {
                    // 计算需要滚动的位置，使当前歌词居中显示
                    const containerHeight = playerLyricsWrapper.clientHeight;
                    const lineHeight = lyricLines[activeIndex].offsetHeight;
                    const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                    
                    // 计算理想的滚动位置（将当前歌词放在容器中间）
                    const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                    
                    // 平滑滚动到理想位置
                    playerLyricsWrapper.scrollTo({
                        top: Math.max(0, idealScrollTop),
                        behavior: 'smooth'
                    });
                }
            }
        }

        // 更新歌词高亮
        function updateLyricHighlight() {
            // 如果没有歌词，直接返回
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset; // 应用偏移量
            let activeIndex = -1;

            // 找到当前应该高亮的歌词索引
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            // 调试信息
            // console.log('当前时间:', currentTime, '活动索引:', activeIndex);

            // 如果没有找到匹配的歌词（可能在第一句之前），不高亮任何歌词
            if (activeIndex === -1) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                lyricLines.forEach(line => {
                    line.classList.remove('current', 'before-current', 'after-current', 'first', 'last');
                });
                return;
            }

            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            // 使用文档片段来减少重排重绘
            const linesToUpdate = [];
            
            lyricLines.forEach((line, index) => {
                let shouldUpdate = false;
                const classesToRemove = [];
                const classesToAdd = [];
                
                // 更新当前行
                if (index === activeIndex) {
                    if (!line.classList.contains('current')) {
                        classesToAdd.push('current');
                        shouldUpdate = true;
                    }
                    ['before-current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                // 更新前一行
                else if (index === activeIndex - 1) {
                    if (!line.classList.contains('before-current')) {
                        classesToAdd.push('before-current');
                        shouldUpdate = true;
                    }
                    ['current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                // 更新后一行
                else if (index === activeIndex + 1) {
                    if (!line.classList.contains('after-current')) {
                        classesToAdd.push('after-current');
                        shouldUpdate = true;
                    }
                    ['current', 'before-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                // 更新其他行
                else {
                    const hasUnwantedClasses = line.classList.contains('current') || 
                                             line.classList.contains('before-current') || 
                                             line.classList.contains('after-current') || 
                                             line.classList.contains('first') || 
                                             line.classList.contains('last');
                    if (hasUnwantedClasses) {
                        ['current', 'before-current', 'after-current', 'first', 'last'].forEach(cls => {
                            if (line.classList.contains(cls)) {
                                classesToRemove.push(cls);
                                shouldUpdate = true;
                            }
                        });
                    }
                }
                
                if (shouldUpdate) {
                    linesToUpdate.push({ line, classesToAdd, classesToRemove });
                }
            });
            
            // 批量更新DOM
            linesToUpdate.forEach(({ line, classesToAdd, classesToRemove }) => {
                classesToRemove.forEach(cls => line.classList.remove(cls));
                classesToAdd.forEach(cls => line.classList.add(cls));
            });

            // 只有在没有手动滚动时才自动滚动
            if (!isLyricsScrolling) {
                // 使用requestAnimationFrame优化滚动性能
                requestAnimationFrame(() => {
                    scrollToActiveLyric(activeIndex);
                });
            }
        }
        
        // 滚动到当前活动歌词
        function scrollToActiveLyric(activeIndex) {
            if (currentLyrics.length === 0 || activeIndex < 0) return;
            
            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            if (lyricLines[activeIndex]) {
                // 计算需要滚动的位置，使当前歌词居中显示
                const containerHeight = playerLyricsWrapper.clientHeight;
                const lineHeight = lyricLines[activeIndex].offsetHeight;
                const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                
                // 计算理想的滚动位置（将当前歌词放在容器中间）
                const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                
                // 直接滚动到理想位置（不使用平滑滚动，以确保及时响应）
                playerLyricsWrapper.scrollTop = Math.max(0, idealScrollTop);
                
                // 调试信息
                // console.log('滚动到歌词:', lyricLines[activeIndex].textContent, '位置:', idealScrollTop);
            }
        }
        
        // 更新播放器区域的多行歌词显示（保持原有的5行显示方式）
        function updatePlayerLyricsDisplay(activeIndex) {
            // 这个函数现在是滚动到活动歌词的别名
            scrollToActiveLyric(activeIndex);
        }
        
        // 调整歌词偏移量
        function adjustLyrics(offset) {
            lyricsOffset += offset;
            showNotification(`歌词${offset > 0 ? '延后' : '提前'}${Math.abs(offset)}秒 (${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}秒)`, 'info');
            
            // 更新偏移量显示
            updateLyricsOffsetDisplay();
            
            // 立即更新歌词显示以反映偏移量变化
            updateLyricHighlight();
        }
        
        // 重置歌词偏移量
        function resetLyricsOffset() {
            lyricsOffset = 0;
            showNotification('歌词偏移已重置', 'success');
            
            // 更新偏移量显示
            updateLyricsOffsetDisplay();
            
            // 立即更新歌词显示以反映偏移量变化
            updateLyricHighlight();
        }
        
        // 更新歌词偏移量显示
        function updateLyricsOffsetDisplay() {
            if (lyricsOffsetDisplay) {
                lyricsOffsetDisplay.textContent = `${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}`;
                lyricsOffsetDisplay.style.opacity = Math.abs(lyricsOffset) > 0.1 ? '1' : '0';
            }
        }

        // 播放控制
        function togglePlay() {
            if (audioPlayer.src) {
                if (isPlaying) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            } else {
                showNotification('请先选择要播放的歌曲', 'warning');
            }
        }

        function previousSong() {
            if (currentIndex > 0) {
                playSong(currentIndex - 1);
            } else {
                showNotification('已经是第一首歌曲', 'info');
            }
        }

        function nextSong() {
            if (currentIndex < currentPlaylist.length - 1) {
                playSong(currentIndex + 1);
            } else {
                // If the user clicks "next" on the last song, either loop back or show a message.
                if (repeatMode === 1) {
                    playSong(0);
                } else {
                    showNotification('已经是最后一首歌曲', 'info');
                }
            }
        }

        // 进度控制
        function seekTo(event) {
            if (audioPlayer.duration) {
                const rect = event.target.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        }

        function setVolume(value) {
            audioPlayer.volume = value / 100;
            
            // 更新音量图标
            const volumeIcon = document.querySelector('.volume-icon');
            if (value == 0) {
                volumeIcon.className = 'fas fa-volume-mute volume-icon';
            } else if (value < 50) {
                volumeIcon.className = 'fas fa-volume-down volume-icon';
            } else {
                volumeIcon.className = 'fas fa-volume-up volume-icon';
            }
        }

        // 格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 通知系统
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' :
                           type === 'error' ? 'rgba(244, 67, 54, 0.9)' :
                           type === 'warning' ? 'rgba(255, 152, 0, 0.9)' :
                           'rgba(33, 150, 243, 0.9)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                font-size: 14px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 音频事件监听
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
            }
            // 始终更新歌词高亮，即使没有duration
            updateLyricHighlight();
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            totalTimeSpan.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            // Check if repeat one is enabled. If so, just play the same song again.
            if (repeatMode === 2) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                return;
            }
            
            // Check if shuffling is enabled. If so, pick a random song from the shuffled list.
            if (isShuffling) {
                const randomIndex = Math.floor(Math.random() * currentPlaylist.length);
                playSong(randomIndex);
                showNotification(`随机播放下一首`, 'info');
                return;
            }
            
            // Check if it's the end of the playlist.
            if (currentIndex < currentPlaylist.length - 1) {
                // Play the next song in the current list (shuffled or original).
                playSong(currentIndex + 1);
            } else {
                // End of the playlist. Check if "repeat all" is enabled.
                if (repeatMode === 1) {
                    playSong(0); // Start from the beginning of the list.
                    showNotification('列表循环：从头开始播放', 'info');
                } else {
                    // No repeat is enabled, so stop playback.
                    isPlaying = false;
                    updatePlayButton();
                    currentCover.classList.remove('playing');
                    showNotification('播放结束', 'info');
                }
            }
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            updatePlayButton();
            currentCover.classList.add('playing');
            // *** MediaSession API：同步播放状态 ***
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'playing';
            }
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            updatePlayButton();
            currentCover.classList.remove('playing');
            // *** MediaSession API：同步播放状态 ***
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowLeft' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                previousSong();
            } else if (e.code === 'ArrowRight' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                nextSong();
            }
        });

        // 搜索框回车事件
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });

        // 歌单导入功能
        async function importPlaylist() {
            const playlistIdInput = document.getElementById('playlistIdInput');
            const playlistId = playlistIdInput.value.trim();
            
            if (!playlistId) {
                showNotification('请输入歌单ID或链接', 'warning');
                return;
            }
            
            // 提取歌单ID（支持完整链接）
            let id = playlistId;
            const match = playlistId.match(/playlist\?id=(\d+)/);
            if (match) {
                id = match[1];
            }
            
            // 检查是否已经保存了这个歌单
            if (savedPlaylists.some(p => p.id === id)) {
                showNotification('该歌单已存在', 'warning');
                return;
            }
            
            try {
                showNotification('正在导入歌单...', 'info');
                
                // 获取歌单信息
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    // 转换歌单数据结构以匹配播放器需要的格式
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '', // 使用picUrl获取封面
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    // 提取创建者信息
                    const creator = data.playlist.creator ? {
                        nickname: data.playlist.creator.nickname,
                        avatarUrl: data.playlist.creator.avatarUrl
                    } : null;
                    
                    const playlist = {
                        id: data.playlist.id,
                        name: data.playlist.name,
                        tracks: tracks,
                        cover: data.playlist.coverImgUrl || '',
                        creator: creator,
                        playCount: data.playlist.playCount || 0,
                        description: data.playlist.description || '',
                        tags: data.playlist.tags || [],
                        createTime: new Date().toISOString()
                    };
                    
                    // 保存到本地存储
                    savedPlaylists.push(playlist);
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    // 更新UI
                    displaySavedPlaylists();
                    
                    // 不再显示导入成功的通知
                    playlistIdInput.value = '';
                } else {
                    showNotification('无法获取歌单信息，请检查ID是否正确', 'error');
                }
            } catch (error) {
                console.error('导入歌单失败:', error);
                // 不再显示导入歌单失败的通知
            }
        }
        
        // 显示保存的歌单
        function displaySavedPlaylists() {
            const container = document.getElementById('savedPlaylists');
            container.innerHTML = '';
            
            if (savedPlaylists.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>暂无保存的歌单</div></div>';
                return;
            }
            
            savedPlaylists.forEach((playlist, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.onclick = () => playPlaylist(index); // 点击整个歌单项也可以播放
                playlistItem.innerHTML = `
                    <div class="playlist-info">
                        <div class="playlist-name">${playlist.name}</div>
                        <div class="playlist-count">${playlist.tracks.length} 首歌曲</div>
                    </div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" onclick="playPlaylist(${index}); event.stopPropagation();" title="播放歌单">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="updatePlaylist(${index}); event.stopPropagation();" title="更新歌单">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="removePlaylist(${index}); event.stopPropagation();" title="删除歌单">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(playlistItem);
            });
        }
        
        // 播放歌单
        function playPlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            currentPlaylist = playlist.tracks;
            currentIndex = -1;
            
            // 保存当前播放的歌单ID
            currentPlaylistId = playlist.id;
            
            // 更新标题显示
            document.getElementById('resultsTitle').innerHTML = playlist.name;
            // 显示歌单标签
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'flex';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'flex';
            
            // 显示歌单详情
            displayPlaylistDetail(playlist);
            
            // 显示在搜索结果区域
            displaySearchResults(playlist.tracks);
            
            // 移除搜索结果的特殊样式类
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.classList.remove('search-results-tall');
            
            // 重新初始化高度同步
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        // 显示歌单详情
        function displayPlaylistDetail(playlist) {
            // 显示歌单详情区域
            document.getElementById('playlistDetail').style.display = 'block';
            
            // 设置歌单封面
            document.getElementById('playlistCover').src = playlist.cover || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIxMCIvPgo8cGF0aCBkPSJNNTAgNDVMMTAwIDc1TDUwIDEwNVY0NVoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIvPgo8L3N2Zz4=';
            
            // 设置歌单标题
            document.getElementById('playlistTitle').textContent = playlist.name;
            
            // 设置创建者信息（如果有）
            if (playlist.creator) {
                document.getElementById('creatorAvatar').src = playlist.creator.avatarUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = playlist.creator.nickname || '未知创建者';
            } else {
                document.getElementById('creatorAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = '未知创建者';
            }
            
            // 设置播放次数和歌曲数量
            document.getElementById('playlistPlayCount').textContent = `播放: ${playlist.playCount || 0}次`;
            document.getElementById('playlistTrackCount').textContent = `歌曲: ${playlist.tracks.length}首`;
            
            // 设置描述（如果有）
            const descriptionEl = document.getElementById('playlistDescription');
            if (playlist.description) {
                descriptionEl.textContent = playlist.description;
                descriptionEl.style.display = 'block';
            } else {
                descriptionEl.style.display = 'none';
            }
            
            // 设置标签（如果有）
            const tagsContainer = document.getElementById('playlistTags');
            tagsContainer.innerHTML = '';
            if (playlist.tags && playlist.tags.length > 0) {
                playlist.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'playlist-tag';
                    tagEl.textContent = tag;
                    tagsContainer.appendChild(tagEl);
                });
            }
        }
        
        // 清除歌单视图
        function clearPlaylistView() {
            // 重置标题显示
            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            // 隐藏歌单标签
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            // 隐藏歌单详情区域
            document.getElementById('playlistDetail').style.display = 'none';
            
            // 清空搜索结果
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            `;
            
            // 为搜索结果添加特殊样式类
            resultsContainer.classList.add('search-results-tall');
            
            // 重置播放列表
            currentPlaylist = [];
            currentIndex = -1;
            currentPlaylistId = null; // 重置当前播放的歌单ID
            
            // 重新初始化高度同步
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        // 删除歌单
        function removePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            if (confirm(`确定要删除歌单 "${playlist.name}" 吗？`)) {
                savedPlaylists.splice(index, 1);
                localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                displaySavedPlaylists();
                showNotification('歌单已删除', 'success');
            }
        }
        
        // 更新歌单
        async function updatePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            try {
                showNotification('正在更新歌单...', 'info');
                
                // 重新获取歌单信息
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${playlist.id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    // 转换歌单数据结构以匹配播放器需要的格式
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '', // 使用picUrl获取封面
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    // 更新保存的歌单
                    savedPlaylists[index].tracks = tracks;
                    // 更新其他歌单信息
                    savedPlaylists[index].name = data.playlist.name;
                    savedPlaylists[index].cover = data.playlist.coverImgUrl || '';
                    savedPlaylists[index].playCount = data.playlist.playCount || 0;
                    savedPlaylists[index].description = data.playlist.description || '';
                    savedPlaylists[index].tags = data.playlist.tags || [];
                    
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    // 更新保存的歌单列表显示
                    displaySavedPlaylists();
                    
                    // 检查当前是否正在播放这个歌单（通过比较歌单ID）
                    let isCurrentPlaylist = false;
                    if (currentPlaylistId === playlist.id) {
                        isCurrentPlaylist = true;
                    }
                    
                    // 如果当前正在播放这个歌单，更新当前播放列表和显示
                    if (isCurrentPlaylist) {
                        // 更新当前播放列表
                        currentPlaylist = tracks;
                        // 更新搜索结果显示
                        displaySearchResults(tracks);
                        // 更新歌单详情显示
                        displayPlaylistDetail(savedPlaylists[index]);
                        // 更新标题显示
                        document.getElementById('resultsTitle').innerHTML = savedPlaylists[index].name;
                        
                        // 移除搜索结果的特殊样式类
                        const resultsContainer = document.getElementById('searchResults');
                        resultsContainer.classList.remove('search-results-tall');
                    }
                    
                    showNotification('歌单更新完成', 'success');
                } else {
                    showNotification('无法获取歌单信息', 'error');
                }
            } catch (error) {
                console.error('更新歌单失败:', error);
                showNotification('更新歌单失败', 'error');
            }
        }
        
        // 计算player-section中除歌词容器外其他元素的总高度
        function calculateOtherElementsHeight(playerSection, lyricsContainer) {
            let otherElementsHeight = 0;
            const playerChildren = playerSection.children;
            
            // 遍历所有子元素，累加除歌词容器外的其他元素高度
            for (let i = 0; i < playerChildren.length; i++) {
                const child = playerChildren[i];
                if (child !== lyricsContainer) {
                    // 获取计算后的实际高度（包括margin/padding/border）
                    const computedStyle = window.getComputedStyle(child);
                    const marginTop = parseFloat(computedStyle.marginTop) || 0;
                    const marginBottom = parseFloat(computedStyle.marginBottom) || 0;
                    otherElementsHeight += child.offsetHeight + marginTop + marginBottom;
                }
            }
            
            // 添加player-section的padding
            const playerComputedStyle = window.getComputedStyle(playerSection);
            const playerPaddingTop = parseFloat(playerComputedStyle.paddingTop) || 0;
            const playerPaddingBottom = parseFloat(playerComputedStyle.paddingBottom) || 0;
            otherElementsHeight += playerPaddingTop + playerPaddingBottom;
            
            return otherElementsHeight;
        }
        
        // 初始化高度同步监听器
        function initHeightSync() {
            // 避免重复初始化
            if (heightSyncInitialized) return;
            
            // 在移动端(768px以下)不启用高度同步功能
            if (window.innerWidth <= 768) return;
            
            const contentSection = document.querySelector('.content-section');
            const playerSection = document.querySelector('.player-section');
            const lyricsContainer = document.getElementById('playerLyricsContainer');
            
            if (!contentSection || !playerSection || !lyricsContainer) return;
            
            // 获取初始高度
            initialContentHeight = contentSection.offsetHeight;
            initialPlayerHeight = playerSection.offsetHeight;
            
            // 计算初始状态下除歌词容器外其他元素的总高度
            const initialOtherElementsHeight = calculateOtherElementsHeight(playerSection, lyricsContainer);
            
            // 创建 ResizeObserver 监听 content-section 高度变化
            if (window.ResizeObserver) {
                contentResizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target === contentSection) {
                            const newContentHeight = entry.contentRect.height;
                            const contentHeightDiff = newContentHeight - initialContentHeight;
                            
                            // 精确计算需要调整的歌词容器高度
                            // 目标是使player-section的高度变化与content-section保持一致
                            const targetPlayerHeight = initialPlayerHeight + contentHeightDiff;
                            
                            // 计算理想的歌词容器高度
                            const idealLyricsHeight = targetPlayerHeight - initialOtherElementsHeight;
                            
                            // 应用新的高度，但确保不会小于初始高度
                            const newLyricsHeight = Math.max(initialLyricsHeight, idealLyricsHeight);
                            lyricsContainer.style.height = `${newLyricsHeight}px`;
                        }
                    }
                });
                
                // 开始监听
                contentResizeObserver.observe(contentSection);
                heightSyncInitialized = true;
            }
        }
        
        // 初始化
        setVolume(80);
        displaySavedPlaylists();
        
        // 页面加载完成后的欢迎信息
        window.addEventListener('load', () => {
            // 不再显示欢迎通知
            // 初始化高度同步
            setTimeout(initHeightSync, 100); // 延迟100ms确保DOM完全渲染
        });
        
        // 监听窗口大小变化，在设备方向改变时重新初始化
        window.addEventListener('resize', () => {
            // 重置初始化状态，以便重新检查是否需要启用高度同步
            heightSyncInitialized = false;
            setTimeout(initHeightSync, 100); // 延迟100ms确保DOM完全渲染
        });
    </script>
</body>
</html>