<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云音乐 - 在线音乐播放器</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #0c0c0c;
            color: #fff;
            overflow-x: hidden;
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -2;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 顶部导航 */
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0;
        }

        .logo i {
            color: #ff6b6b;
            font-size: 28px;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 40px;
            position: relative;
        }

        .search-wrapper {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .search-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            outline: none;
            min-width: 0;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .source-select {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 12px 15px;
            outline: none;
            cursor: pointer;
            display: block;
        }

        .source-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        .search-btn {
            background: #ff6b6b;
            border: none;
            color: #fff;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
            flex-shrink: 0;
        }

        .search-btn:hover {
            background: #ff5252;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            display: flex;
            gap: 25px;
            min-height: calc(100vh - 200px);
            width: 100%;
            box-sizing: border-box;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 0;
            overflow: hidden;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        
        .playlist-tag-indicator {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            padding: 2px 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #resultsTitle {
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            position: relative;
            padding: 2px 4px;
            transition: all 0.3s ease;
        }

        .search-results {
            max-height: 250px;
            min-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            flex: 1;
        }

        .search-results.search-results-tall {
            max-height: 600px;
        }

        .search-results:not(:has(.playlist-tag-indicator:visible)) {
            max-height: 600px;
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-results::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
            max-width: 100%;
        }

        .song-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .song-item:hover::before {
            left: 100%;
        }

        .song-item.active {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1));
            border: 1px solid rgba(255, 107, 107, 0.5);
        }

        .song-index {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
        }

        .song-item.active .song-index {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: #fff;
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 100%;
            max-width: 100%;
            box-sizing: border-box;
            flex: 1;
            width: 0;
        }
        
        .player-lyrics-container {
            margin: 20px 0;
            height: 150px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(5px);
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            overflow: hidden;
            transition: height 0.15s ease;
        }
        
        .player-lyrics-wrapper {
            position: relative;
            height: 100%;
            overflow-y: auto;
            display: block;
            scrollbar-width: none;
            -ms-overflow-style: none;
            overflow-x: hidden;
        }
        
        .lyrics-auto-height {
            height: auto;
            min-height: 150px;
        }
        
        .player-lyrics-wrapper::-webkit-scrollbar {
            display: none;
        }
        
        .player-lyrics-list {
            position: relative;
            width: 100%;
            table-layout: fixed;
        }
        
        .player-lyric-line {
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            padding: 0 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            transform-origin: center;
            margin: 3px 0;
        }
        
        .player-lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            height: auto;
            min-height: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: clip;
            max-width: 100%;
            margin: 3px 0;
        }
        
        .player-lyric-line.current {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            font-size: 14px;
            margin: 6px 0;
        }
        
        .player-lyric-line.current.long-text {
            font-size: 14px;
            margin: 6px 0;
        }
        
        .player-lyric-line.before-current,
        .player-lyric-line.after-current {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .player-lyric-line.first,
        .player-lyric-line.last {
            color: rgba(255, 255, 255, 0.3);
            filter: blur(1px);
        }
        
        .lyrics-adjust-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .lyrics-offset-display {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .player-lyrics-container:hover .lyrics-offset-display {
            opacity: 1;
        }
        
        .lyrics-adjust-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .lyrics-adjust-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .current-song {
            text-align: center;
            margin-bottom: 25px;
        }

        .current-cover-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .current-cover {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            border: 6px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .current-cover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        .current-cover::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }

        .current-cover.playing {
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .current-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;    
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn.small {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }

        .play-btn {
            width: 65px;
            height: 65px;
            font-size: 28px;
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            flex-shrink: 0;
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff4444);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ff8a80);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .volume-icon {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            flex-shrink: 0;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #ff6b6b;
            border-radius: 50%;
            cursor: pointer;
        }

        .quality-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            flex-shrink: 0;
        }

        .quality-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            outline: none;
            cursor: pointer;
            font-size: 14px;
            max-width: 150px;
        }

        .quality-select option {
            background: #2a2a2a;
            color: #fff;
            padding: 8px;
        }

        .download-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .download-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .song-actions {
            display: flex;
            gap: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
            padding-right: 10px;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .lyric-line {
            padding: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 6px;
            padding-left: 10px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .lyric-line.active {
            color: #ff6b6b;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.02);
            border-left: 3px solid #ff6b6b;
        }

        .playlist-import {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        .playlist-detail {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
            flex-shrink: 0;
        }
        
        .playlist-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .playlist-cover {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .playlist-info-container {
            flex: 1;
            min-width: 0;
        }
        
        .playlist-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-creator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .creator-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .creator-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .playlist-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        
        .playlist-description {
            margin-bottom: 15px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            white-space: normal;
            word-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .playlist-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .playlist-tag {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .import-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .import-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            outline: none;
            font-size: 14px;
            min-width: 0;
        }

        .import-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .import-btn {
            padding: 12px 20px;
            background: #ff6b6b;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .import-btn:hover {
            background: #ff5252;
        }

        .saved-playlists {
            margin-top: 20px;
        }

        .playlist-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item .playlist-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .playlist-item .playlist-name {
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-item .playlist-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .playlist-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .playlist-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .playlist-action-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .loading, .error, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading i, .error i, .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .loading i {
            animation: spin 1s linear infinite;
            color: #ff6b6b;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error i {
            color: #ff5252;
        }

        .empty-state i {
            color: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 1400px) {
            .main-container {
                gap: 20px;
                max-width: 1200px;
            }
            
            .content-section, .player-section {
                width: auto;
            }
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                width: 100%;
                max-width: 100%;
            }
            
            .nav-container {
                padding: 0 20px;
            }
            
            .search-container {
                margin: 0 20px;
            }
            
            .player-section {
                position: static;
                min-height: auto;
                height: auto;
            }
            
            .content-section, .player-section {
                max-width: 100%;
                overflow: hidden;
                width: auto;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
                padding: 0 15px;
            }
            
            .search-container {
                margin: 0;
                max-width: none;
                width: 100%;
                padding: 0;
            }
            
            .search-wrapper {
                width: 100%;
            }
            
            .source-select {
                display: block;
            }
            
            .search-btn {
                padding: 12px 15px;
                min-width: 45px;
            }
            
            .search-btn i {
                font-size: 16px;
            }
            
            .current-cover {
                width: 180px;
                height: 180px;
            }
            
            .player-controls {
                gap: 15px;
            }
            
            .download-container {
                grid-template-columns: 1fr;
            }
            
            .import-form {
                flex-direction: column;
            }
            
            .import-btn {
                justify-content: center;
            }
            
            .playlist-header {
                flex-direction: column;
            }
            
            .playlist-cover {
                width: 100%;
                height: auto;
                aspect-ratio: 1/1;
            }
            
            .player-lyrics-container {
                height: 120px;
                padding: 8px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                transition: none;
            }
            
            .player-lyric-line {
                font-size: 13px;
                height: 26px;
                line-height: 26px;
                padding: 0 10px;
                max-width: 100%;
                box-sizing: border-box;
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                font-size: 13px;
                margin: 6px 0;
            }
            
            .player-lyric-line.long-text {
                font-size: 11px;
                margin: 3px 0;
            }
            
            .player-lyric-line.current.long-text {
                font-size: 13px;
                margin: 6px 0;
            }
            
            .playlist-tag-indicator {
                font-size: 12px;
                padding: 2px 10px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 20px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .search-results {
                max-height: 380px;
                min-height: 380px;
            }
            
            .search-results.search-results-tall {
                max-height: 600px;
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: 0 10px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo i {
                font-size: 24px;
            }
            
            .search-input {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .source-select {
                padding: 10px 10px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 10px 12px;
            }
            
            .content-section, .player-section, .playlist-import {
                padding: 20px 15px;
            }
            
            .song-item {
                padding: 12px 15px;
            }
            
            .song-name {
                font-size: 15px;
            }
            
            .song-artist {
                font-size: 13px;
            }
            
            .section-title {
                font-size: 18px;
                flex-wrap: nowrap;
            }
            
            .playlist-tag-indicator {
                font-size: 11px;
                padding: 1px 8px;
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                color: #ffffff;
                white-space: nowrap;
                min-width: 0;
                flex-shrink: 0;
            }
            
            #resultsTitle {
                font-size: 18px;
                font-weight: 700;
            }
            
            #resultsTitle:not(:has(.playlist-tag-indicator)) {
                background: linear-gradient(90deg, #ff6b6b, #ff8a80);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .playlist-item .playlist-name {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .playlist-item .playlist-count {
                font-size: 12px;
            }

            .player-lyric-line {
                font-size: 12px;
                height: 24px;
                line-height: 24px;
                margin: 3px 0;
            }
            
            .player-lyric-line.current {
                font-size: 12px;
                margin: 6px 0;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .lyrics-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .lyric-line.long-text {
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            padding: 4px 0;
        }

        /* --- Interactive Character Styles --- */
        #character-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            cursor: pointer;
            text-align: center;
            user-select: none;
        }

        #character {
            width: 200px;
            height: 200px;
            animation: float 4s ease-in-out infinite;
            transition: transform 0.2s ease-in-out;
        }

        #character:hover {
            transform: scale(1.05) translateY(-5px);
        }

        #character.wave {
            animation: wave-animation 0.6s ease-in-out;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes wave-animation {
            0% { transform: rotate(0deg) scale(1.05); }
            25% { transform: rotate(15deg) scale(1.05); }
            50% { transform: rotate(-10deg) scale(1.05); }
            75% { transform: rotate(15deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1.05); }
        }

        #greeting-bubble {
            position: absolute;
            bottom: 95%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background-color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        #greeting-bubble.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>

    <!-- 顶部导航 -->
    <nav class="navbar" role="navigation" aria-label="主导航">
        <div class="nav-container">
            <div class="logo" role="banner">
                <i class="fas fa-music" aria-hidden="true"></i>
                <span>云音乐</span>
            </div>
            
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑..." id="searchInput" aria-label="搜索音乐">
                    <select class="source-select" id="sourceSelect" aria-label="选择音乐来源">
                        <option value="netease">网易云音乐</option>
                        <option value="tencent">QQ音乐</option>
                        <option value="kuwo">酷我音乐</option>
                        <option value="joox">JOOX</option>
                        <option value="kugou">酷狗音乐</option>
                        <option value="migu">咪咕音乐</option>
                        <option value="deezer">Deezer</option>
                        <option value="spotify">Spotify</option>
                        <option value="apple">Apple Music</option>
                        <option value="ytmusic">YouTube Music</option>
                        <option value="tidal">TIDAL</option>
                        <option value="qobuz">Qobuz</option>
                        <option value="ximalaya">喜马拉雅</option>
                    </select>
                    <button class="search-btn" onclick="searchMusic()" aria-label="搜索">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="main-container">
        <!-- 搜索结果区域 -->
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-list-music"></i>
                <span class="playlist-tag-indicator" style="display: none;">歌单</span>
                <span id="resultsTitle">搜索结果</span>
                <button id="clearPlaylistBtn" class="action-btn" style="margin-left: auto; display: none;" onclick="clearPlaylistView()" title="清除歌单视图">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            <div class="search-results" id="searchResults">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            </div>

            <!-- 歌单详情区域 -->
            <div class="playlist-detail" id="playlistDetail">
                <div class="playlist-header">
                    <img class="playlist-cover" id="playlistCover" src="" alt="歌单封面">
                    <div class="playlist-info-container">
                        <h2 class="playlist-title" id="playlistTitle"></h2>
                        <div class="playlist-creator">
                            <img class="creator-avatar" id="creatorAvatar" src="" alt="创建者头像">
                            <span class="creator-name" id="creatorName"></span>
                        </div>
                        <div class="playlist-stats">
                            <span id="playlistPlayCount"></span>
                            <span id="playlistTrackCount"></span>
                        </div>
                        <div class="playlist-tags" id="playlistTags">
                            <!-- 标签将在这里显示 -->
                        </div>
                    </div>
                </div>
                <div class="playlist-description" id="playlistDescription"></div>
            </div>
            
            <!-- 歌单导入区域 -->
            <div class="playlist-import">
                <h2 class="section-title">
                    <i class="fas fa-folder-plus"></i>
                    导入网易云歌单
                </h2>
                <div class="import-form">
                    <input type="text" class="import-input" id="playlistIdInput" placeholder="粘贴 ID 或 链接">
                    <button class="import-btn" onclick="importPlaylist()">
                        <i class="fas fa-download"></i>
                        <span>导入</span>
                    </button>
                </div>
                <div class="saved-playlists" id="savedPlaylists">
                    <!-- 保存的歌单将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 播放器区域 -->
        <div class="player-section">
            <div class="current-song">
                <div class="current-cover-container">
                    <img class="current-cover" id="currentCover" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=" alt="专辑封面">
                </div>
                <div class="current-info">
                    <h3 id="currentTitle">未选择歌曲</h3>
                    <p id="currentArtist">请搜索并选择要播放的歌曲</p>
                </div>
            </div>

            <!-- 播放器歌词显示 -->
            <div class="player-lyrics-container" id="playerLyricsContainer">
                <div class="lyrics-offset-display" id="lyricsOffsetDisplay">±0.0</div>
                <div class="player-lyrics-wrapper" id="playerLyricsWrapper">
                    <div class="player-lyrics-list" id="playerLyricsList"></div>
                </div>

            </div>
                <div class="lyrics-adjust-controls">
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(0.5)" title="歌词延后0.5秒" aria-label="歌词延后0.5秒">←</button>
                    <button class="lyrics-adjust-btn" onclick="resetLyricsOffset()" title="重置歌词偏移" aria-label="重置歌词偏移">↺</button>
                    <button class="lyrics-adjust-btn" onclick="adjustLyrics(-0.5)" title="歌词提前0.5秒" aria-label="歌词提前0.5秒">→</button>
                </div>
            <div class="player-controls">
                <button class="control-btn small" onclick="previousSong()" aria-label="上一首">
                    <i class="fas fa-step-backward" aria-hidden="true"></i>
                </button>
                <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()" aria-label="播放/暂停">
                    <i class="fas fa-play" aria-hidden="true"></i>
                </button>
                <button class="control-btn small" onclick="nextSong()" aria-label="下一首">
                    <i class="fas fa-step-forward" aria-hidden="true"></i>
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <!-- 音质选择 -->
            <div class="quality-container">
                <div class="quality-label">
                    <i class="fas fa-music"></i>
                    <span>音质</span>
                </div>
                <select class="quality-select" id="qualitySelect">
                    <option value="128">标准 128K</option>
                    <option value="192">较高 192K</option>
                    <option value="320" selected>高品质 320K</option>
                    <option value="740">无损 FLAC</option>
                    <option value="999">Hi-Res</option>
                </select>
            </div>

            <div class="volume-container">
                <i class="fas fa-volume-up volume-icon"></i>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" onchange="setVolume(this.value)">
            </div>

            <!-- 下载区域 -->
            <div class="download-container">
                <button class="download-btn" onclick="downloadCurrentSong()" id="downloadSongBtn" disabled>
                    <i class="fas fa-download"></i>
                    <span>下载音乐</span>
                </button>
                <button class="download-btn" onclick="downloadCurrentLyric()" id="downloadLyricBtn" disabled>
                    <i class="fas fa-file-text"></i>
                    <span>下载歌词</span>
                </button>
            </div>

            <audio id="audioPlayer" preload="metadata"></audio>
        </div>
    </div>

    <!-- Interactive Character -->
    <div id="character-container">
        <div id="greeting-bubble"></div>
        <svg id="character" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
            <g>
                <ellipse cx="125" cy="135" rx="100" ry="90" fill="#ff6b6b"/>
                <circle cx="95" cy="110" r="15" fill="white"/>
                <circle cx="155" cy="110" r="15" fill="white"/>
                <circle cx="95" cy="112" r="7" fill="#333"/>
                <circle cx="155" cy="112" r="7" fill="#333"/>
                <path d="M 90 160 Q 125 190 160 160" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
            </g>
        </svg>
    </div>

    <script>
        const API_BASE = 'https://music-api.gdstudio.xyz/api.php';
        let currentPlaylist = [];
        let currentIndex = -1;
        let currentPlaylistId = null;
        let currentLyrics = [];
        let isPlaying = false;
        let savedPlaylists = JSON.parse(localStorage.getItem('savedPlaylists')) || [];

        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const totalTimeSpan = document.getElementById('totalTime');
        const playerLyricsList = document.getElementById('playerLyricsList');
        const playerLyricsWrapper = document.getElementById('playerLyricsWrapper');
        const playerLyricsContainer = document.getElementById('playerLyricsContainer');
        const lyricsOffsetDisplay = document.getElementById('lyricsOffsetDisplay');
        const currentCover = document.getElementById('currentCover');
        
        let lyricsOffset = 0;
        let currentSongId = null;
        
        let isLyricsScrolling = false;
        let lyricsScrollTimeout = null;
        let lastScrollTime = 0;
        
        let initialContentHeight = 0;
        let initialLyricsHeight = 150;
        let initialPlayerHeight = 0;
        let contentResizeObserver = null;
        let heightSyncInitialized = false;

        async function searchMusic() {
            const keyword = document.getElementById('searchInput').value.trim();
            const source = document.getElementById('sourceSelect').value;
            
            if (!keyword) {
                showNotification('请输入搜索关键词', 'warning');
                return;
            }

            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            document.getElementById('playlistDetail').style.display = 'none';
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>正在搜索音乐...</div>
                </div>
            `;
            
            resultsContainer.classList.add('search-results-tall');

            try {
                const response = await fetch(`${API_BASE}?types=search&source=${source}&name=${encodeURIComponent(keyword)}&count=30`);
                const data = await response.json();

                if (data && data.length > 0) {
                    currentPlaylist = data;
                    currentPlaylistId = null;
                    displaySearchResults(data);
                    setTimeout(() => {
                        heightSyncInitialized = false;
                        initHeightSync();
                    }, 100);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>未找到相关歌曲，请尝试其他关键词</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('搜索失败:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <i class="fas fa-wifi"></i>
                        <div>网络连接失败，请检查网络后重试</div>
                    </div>
                `;
            }
        }

        async function getAlbumCoverUrl(song, size = 300) {
            if (song.picUrl) {
                return song.picUrl;
            }
            
            const picId = song.pic_id || song.id;
            
            if (!picId) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHZpZXdCb3g9IjAgMCA1NSA1NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU1IiBoZWlnaHQ9IjU1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSI4Ii8+CjxwYXRoIGQ9Ik0yNy41IDE4TDM1IDI3LjVIMzBWMzdIMjVWMjcuNUgyMEwyNy41IDE4WiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
            }

            try {
                const response = await fetch(`${API_BASE}?types=pic&source=${song.source}&id=${picId}&size=${size}`);
                const data = await response.json();
                
                if (data && data.url) {
                    return data.url;
                }
            } catch (error) {
                console.error('获取专辑图失败:', error);
            }
            
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHZpZXdCb3g9IjAgMCA1NSA1NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjU1IiBoZWlnaHQ9IjU1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSI4Ii8+CjxwYXRoIGQ9Ik0yNy41IDE4TDM1IDI3LjVIMzBWMzdIMjVWMjcuNUgyMEwyNy41IDE4WiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo=';
        }

        async function displaySearchResults(songs) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            for (let index = 0; index < songs.length; index++) {
                const song = songs[index];
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.onclick = () => playSong(index);

                songItem.innerHTML = `
                    <div class="song-index" aria-hidden="true">${(index + 1).toString().padStart(2, '0')}</div>
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}</div>
                    </div>
                    <div class="song-actions">
                        <button class="action-btn" onclick="downloadSong(${index})" title="下载音乐" aria-label="下载音乐 ${song.name}">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn" onclick="downloadLyric(${index})" title="下载歌词" aria-label="下载歌词 ${song.name}">
                            <i class="fas fa-file-text" aria-hidden="true"></i>
                        </button>
                    </div>
                `;

                resultsContainer.appendChild(songItem);
            }
        }

        async function playSong(index) {
            if (index < 0 || index >= currentPlaylist.length) return;

            currentIndex = index;
            const song = currentPlaylist[index];

            await updateCurrentSongInfo(song);
            updateActiveItem();
            
            lyricsOffset = 0;
            currentSongId = song.id;

            try {
                showNotification('正在加载音乐...', 'info');
                
                const quality = document.getElementById('qualitySelect').value;
                
                const urlResponse = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const urlData = await urlResponse.json();

                if (urlData && urlData.url) {
                    audioPlayer.src = urlData.url;
                    audioPlayer.load();
                    
                    loadLyrics(song);
                    
                    document.getElementById('downloadSongBtn').disabled = false;
                    document.getElementById('downloadLyricBtn').disabled = false;
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButton();
                            currentCover.classList.add('playing');
                            showNotification(`开始播放 (${getQualityText(urlData.br || quality)})`, 'success');
                        }).catch(error => {
                            console.error('播放失败:', error);
                            showNotification('播放失败，请尝试其他歌曲', 'error');
                        });
                    }
                } else {
                    showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
                }
            } catch (error) {
                console.error('播放失败:', error);
                showNotification('播放失败，请检查网络连接', 'error');
            }
        }

        function getQualityText(br) {
            const qualityMap = {
                '128': '标准音质',
                '192': '较高音质',
                '320': '高品质',
                '740': '无损音质',
                '999': 'Hi-Res音质'
            };
            return qualityMap[br] || `${br}K`;
        }

        async function downloadCurrentSong() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载的歌曲', 'warning');
                return;
            }
            
            const song = currentPlaylist[currentIndex];
            await downloadSong(currentIndex);
        }

        async function downloadCurrentLyric() {
            if (currentIndex === -1) {
                showNotification('请先选择要下载歌词的歌曲', 'warning');
                return;
            }
            
            await downloadLyric(currentIndex);
        }

        async function downloadSong(index) {
            const song = currentPlaylist[index];
            const quality = document.getElementById('qualitySelect').value;
            
            try {
                showNotification('正在获取下载链接...', 'info');
                
                const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${quality}`);
                const data = await response.json();
                
                if (data && data.url) {
                    const link = document.createElement('a');
                    link.href = data.url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.mp3`;
                    link.target = '_blank';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('开始下载音乐文件', 'success');
                } else {
                    showNotification('无法获取下载链接', 'error');
                }
            } catch (error) {
                console.error('下载失败:', error);
                showNotification('下载失败，请稍后重试', 'error');
            }
        }

        async function downloadLyric(index) {
            const song = currentPlaylist[index];
            
            try {
                showNotification('正在获取歌词...', 'info');
                
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();
                
                if (data && data.lyric) {
                    let lyricContent = `歌曲：${song.name}\n`;
                    lyricContent += `歌手：${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}\n`;
                    lyricContent += `专辑：${song.album}\n`;
                    lyricContent += `来源：${song.source}\n\n`;
                    lyricContent += data.lyric;
                    
                    if (data.tlyric) {
                        lyricContent += '\n=== 翻译歌词 ===\n';
                        lyricContent += data.tlyric;
                    }
                    
                    const blob = new Blob([lyricContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.lrc`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(url);
                    showNotification('歌词下载完成', 'success');
                } else {
                    showNotification('该歌曲暂无歌词', 'warning');
                }
            } catch (error) {
                console.error('下载歌词失败:', error);
                showNotification('下载歌词失败，请稍后重试', 'error');
            }
        }

        document.getElementById('qualitySelect').addEventListener('change', () => {
            if (currentIndex !== -1 && audioPlayer.src) {
                const currentTime = audioPlayer.currentTime;
                const wasPlaying = isPlaying;
                
                playSong(currentIndex).then(() => {
                    audioPlayer.currentTime = currentTime;
                    if (!wasPlaying) {
                        audioPlayer.pause();
                    }
                });
            }
        });

        async function updateCurrentSongInfo(song) {
            document.getElementById('currentTitle').textContent = song.name;
            document.getElementById('currentArtist').textContent =
                `${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}`;

            const coverUrl = await getAlbumCoverUrl(song, 500);
            currentCover.src = coverUrl;
        }

        function updateActiveItem() {
            document.querySelectorAll('.song-item').forEach((item, index) => {
                item.classList.toggle('active', index === currentIndex);
            });
        }

        function updatePlayButton() {
            const icon = playBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        async function loadLyrics(song) {
            lyricsOffset = 0;
            currentSongId = song.id;
            
            updateLyricsOffsetDisplay();
            
            try {
                const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
                const data = await response.json();

                if (data && data.lyric) {
                    parseLyrics(data.lyric);
                } else {
                    displayPlayerLyrics([]);
                    currentLyrics = [];
                }
            } catch (error) {
                console.error('获取歌词失败:', error);
                displayPlayerLyrics([]);
                currentLyrics = [];
            }
        }

        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            currentLyrics = [];

            lines.forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const text = match[4].trim();

                    if (text) {
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        currentLyrics.push({ time, text });
                    }
                }
            });

            currentLyrics.sort((a, b) => a.time - b.time);
            displayPlayerLyrics(currentLyrics);
            
            initLyricsScrollListeners();
        }

        function displayPlayerLyrics(lyrics) {
            playerLyricsList.innerHTML = '';
            
            if (lyrics.length === 0) {
                playerLyricsList.innerHTML = '<div class="player-lyric-line empty">暂无歌词</div>';
                return;
            }
            
            for (let i = 0; i < lyrics.length; i++) {
                const lyricLine = document.createElement('div');
                lyricLine.className = 'player-lyric-line';
                lyricLine.textContent = lyrics[i].text;
                lyricLine.dataset.time = lyrics[i].time;
                
                if (lyrics[i].text.length > 30) {
                    lyricLine.classList.add('long-text');
                }
                
                playerLyricsList.appendChild(lyricLine);
            }
        }

        function initLyricsScrollListeners() {
            playerLyricsWrapper.removeEventListener('wheel', handleLyricsScroll);
            playerLyricsWrapper.removeEventListener('click', handleLyricClick);
            
            playerLyricsWrapper.addEventListener('wheel', handleLyricsScroll, { passive: false });
            
            playerLyricsWrapper.addEventListener('click', handleLyricClick);
        }

        function handleLyricsScroll(e) {
            e.preventDefault();
            
            playerLyricsWrapper.scrollTop += e.deltaY;
            
            isLyricsScrolling = true;
            lastScrollTime = Date.now();
            
            if (lyricsScrollTimeout) {
                clearTimeout(lyricsScrollTimeout);
            }
            
            lyricsScrollTimeout = setTimeout(() => {
                isLyricsScrolling = false;
                resetLyricsPosition();
            }, 3000);
        }

        function handleLyricClick(e) {
            let target = e.target;
            while (target && !target.classList.contains('player-lyric-line')) {
                target = target.parentElement;
            }
            
            if (target && target.classList.contains('player-lyric-line')) {
                const time = parseFloat(target.dataset.time);
                
                if (!isNaN(time)) {
                    audioPlayer.currentTime = time;
                    
                    showNotification(`已跳转到 ${formatTime(time)}`, 'success');
                    
                    if (lyricsScrollTimeout) {
                        clearTimeout(lyricsScrollTimeout);
                    }
                    
                    isLyricsScrolling = false;
                    
                    updateLyricHighlight();
                }
            }
        }

        function resetLyricsPosition() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset;
            let activeIndex = -1;

            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            
            if (activeIndex >= 0) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                if (lyricLines[activeIndex]) {
                    const containerHeight = playerLyricsWrapper.clientHeight;
                    const lineHeight = lyricLines[activeIndex].offsetHeight;
                    const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                    
                    const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                    
                    playerLyricsWrapper.scrollTo({
                        top: Math.max(0, idealScrollTop),
                        behavior: 'smooth'
                    });
                }
            }
        }

        function updateLyricHighlight() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime - lyricsOffset;
            let activeIndex = -1;

            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if (activeIndex === -1) {
                const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
                lyricLines.forEach(line => {
                    line.classList.remove('current', 'before-current', 'after-current', 'first', 'last');
                });
                return;
            }

            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            const linesToUpdate = [];
            
            lyricLines.forEach((line, index) => {
                let shouldUpdate = false;
                const classesToRemove = [];
                const classesToAdd = [];
                
                if (index === activeIndex) {
                    if (!line.classList.contains('current')) {
                        classesToAdd.push('current');
                        shouldUpdate = true;
                    }
                    ['before-current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                else if (index === activeIndex - 1) {
                    if (!line.classList.contains('before-current')) {
                        classesToAdd.push('before-current');
                        shouldUpdate = true;
                    }
                    ['current', 'after-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                else if (index === activeIndex + 1) {
                    if (!line.classList.contains('after-current')) {
                        classesToAdd.push('after-current');
                        shouldUpdate = true;
                    }
                    ['current', 'before-current', 'first', 'last'].forEach(cls => {
                        if (line.classList.contains(cls)) {
                            classesToRemove.push(cls);
                            shouldUpdate = true;
                        }
                    });
                } 
                else {
                    const hasUnwantedClasses = line.classList.contains('current') || 
                                                line.classList.contains('before-current') || 
                                                line.classList.contains('after-current') || 
                                                line.classList.contains('first') || 
                                                line.classList.contains('last');
                    if (hasUnwantedClasses) {
                        ['current', 'before-current', 'after-current', 'first', 'last'].forEach(cls => {
                            if (line.classList.contains(cls)) {
                                classesToRemove.push(cls);
                                shouldUpdate = true;
                            }
                        });
                    }
                }
                
                if (shouldUpdate) {
                    linesToUpdate.push({ line, classesToAdd, classesToRemove });
                }
            });
            
            linesToUpdate.forEach(({ line, classesToAdd, classesToRemove }) => {
                classesToRemove.forEach(cls => line.classList.remove(cls));
                classesToAdd.forEach(cls => line.classList.add(cls));
            });

            if (!isLyricsScrolling) {
                requestAnimationFrame(() => {
                    scrollToActiveLyric(activeIndex);
                });
            }
        }
        
        function scrollToActiveLyric(activeIndex) {
            if (currentLyrics.length === 0 || activeIndex < 0) return;
            
            const lyricLines = playerLyricsList.querySelectorAll('.player-lyric-line');
            if (lyricLines[activeIndex]) {
                const containerHeight = playerLyricsWrapper.clientHeight;
                const lineHeight = lyricLines[activeIndex].offsetHeight;
                const lineOffsetTop = lyricLines[activeIndex].offsetTop;
                
                const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
                
                playerLyricsWrapper.scrollTop = Math.max(0, idealScrollTop);
            }
        }
        
        function updatePlayerLyricsDisplay(activeIndex) {
            scrollToActiveLyric(activeIndex);
        }
        
        function adjustLyrics(offset) {
            lyricsOffset += offset;
            showNotification(`歌词${offset > 0 ? '延后' : '提前'}${Math.abs(offset)}秒 (${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}秒)`, 'info');
            
            updateLyricsOffsetDisplay();
            
            updateLyricHighlight();
        }
        
        function resetLyricsOffset() {
            lyricsOffset = 0;
            showNotification('歌词偏移已重置', 'success');
            
            updateLyricsOffsetDisplay();
            
            updateLyricHighlight();
        }
        
        function updateLyricsOffsetDisplay() {
            if (lyricsOffsetDisplay) {
                lyricsOffsetDisplay.textContent = `${lyricsOffset > 0 ? '+' : ''}${lyricsOffset.toFixed(1)}`;
                lyricsOffsetDisplay.style.opacity = Math.abs(lyricsOffset) > 0.1 ? '1' : '0';
            }
        }

        function togglePlay() {
            if (audioPlayer.src) {
                if (isPlaying) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            } else {
                showNotification('请先选择要播放的歌曲', 'warning');
            }
        }

        function previousSong() {
            if (currentIndex > 0) {
                playSong(currentIndex - 1);
            } else {
                showNotification('已经是第一首歌曲', 'info');
            }
        }

        function nextSong() {
            if (currentIndex < currentPlaylist.length - 1) {
                playSong(currentIndex + 1);
            } else {
                showNotification('已经是最后一首歌曲', 'info');
            }
        }

        function seekTo(event) {
            if (audioPlayer.duration) {
                const rect = event.target.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        }

        function setVolume(value) {
            audioPlayer.volume = value / 100;
            
            const volumeIcon = document.querySelector('.volume-icon');
            if (value == 0) {
                volumeIcon.className = 'fas fa-volume-mute volume-icon';
            } else if (value < 50) {
                volumeIcon.className = 'fas fa-volume-down volume-icon';
            } else {
                volumeIcon.className = 'fas fa-volume-up volume-icon';
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' :
                             type === 'error' ? 'rgba(244, 67, 54, 0.9)' :
                             type === 'warning' ? 'rgba(255, 152, 0, 0.9)' :
                             'rgba(33, 150, 243, 0.9)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                font-size: 14px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
            }
            updateLyricHighlight();
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            totalTimeSpan.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            lyricsOffset = 0;
            nextSong();
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            updatePlayButton();
            currentCover.classList.add('playing');
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            updatePlayButton();
            currentCover.classList.remove('playing');
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowLeft' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                previousSong();
            } else if (e.code === 'ArrowRight' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                nextSong();
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });

        async function importPlaylist() {
            const playlistIdInput = document.getElementById('playlistIdInput');
            const playlistId = playlistIdInput.value.trim();
            
            if (!playlistId) {
                showNotification('请输入歌单ID或链接', 'warning');
                return;
            }
            
            let id = playlistId;
            const match = playlistId.match(/playlist\?id=(\d+)/);
            if (match) {
                id = match[1];
            }
            
            if (savedPlaylists.some(p => p.id === id)) {
                showNotification('该歌单已存在', 'warning');
                return;
            }
            
            try {
                showNotification('正在导入歌单...', 'info');
                
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '',
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    const creator = data.playlist.creator ? {
                        nickname: data.playlist.creator.nickname,
                        avatarUrl: data.playlist.creator.avatarUrl
                    } : null;
                    
                    const playlist = {
                        id: data.playlist.id,
                        name: data.playlist.name,
                        tracks: tracks,
                        cover: data.playlist.coverImgUrl || '',
                        creator: creator,
                        playCount: data.playlist.playCount || 0,
                        description: data.playlist.description || '',
                        tags: data.playlist.tags || [],
                        createTime: new Date().toISOString()
                    };
                    
                    savedPlaylists.push(playlist);
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    displaySavedPlaylists();
                    
                    playlistIdInput.value = '';
                } else {
                    showNotification('无法获取歌单信息，请检查ID是否正确', 'error');
                }
            } catch (error) {
                console.error('导入歌单失败:', error);
            }
        }
        
        function displaySavedPlaylists() {
            const container = document.getElementById('savedPlaylists');
            container.innerHTML = '';
            
            if (savedPlaylists.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>暂无保存的歌单</div></div>';
                return;
            }
            
            savedPlaylists.forEach((playlist, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.onclick = () => playPlaylist(index);
                playlistItem.innerHTML = `
                    <div class="playlist-info">
                        <div class="playlist-name">${playlist.name}</div>
                        <div class="playlist-count">${playlist.tracks.length} 首歌曲</div>
                    </div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" onclick="playPlaylist(${index}); event.stopPropagation();" title="播放歌单">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="updatePlaylist(${index}); event.stopPropagation();" title="更新歌单">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="playlist-action-btn" onclick="removePlaylist(${index}); event.stopPropagation();" title="删除歌单">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(playlistItem);
            });
        }
        
        function playPlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            currentPlaylist = playlist.tracks;
            currentIndex = -1;
            
            currentPlaylistId = playlist.id;
            
            document.getElementById('resultsTitle').innerHTML = playlist.name;
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'flex';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'flex';
            
            displayPlaylistDetail(playlist);
            
            displaySearchResults(playlist.tracks);
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.classList.remove('search-results-tall');
            
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        function displayPlaylistDetail(playlist) {
            document.getElementById('playlistDetail').style.display = 'block';
            
            document.getElementById('playlistCover').src = playlist.cover || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIxMCIvPgo8cGF0aCBkPSJNNTAgNDVMMTAwIDc1TDUwIDEwNVY0NVoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIvPgo8L3N2Zz4=';
            
            document.getElementById('playlistTitle').textContent = playlist.name;
            
            if (playlist.creator) {
                document.getElementById('creatorAvatar').src = playlist.creator.avatarUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = playlist.creator.nickname || '未知创建者';
            } else {
                document.getElementById('creatorAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIHJ4PSIyMCIvPgo8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI1IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMykiLz4KPHBhdGggZD0iTTEwIDI1QzEwIDI1IDE1IDM1IDIwIDM1QzI1IDM1IDMwIDI1IDMwIDI1IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4zKSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+';
                document.getElementById('creatorName').textContent = '未知创建者';
            }
            
            document.getElementById('playlistPlayCount').textContent = `播放: ${playlist.playCount || 0}次`;
            document.getElementById('playlistTrackCount').textContent = `歌曲: ${playlist.tracks.length}首`;
            
            const descriptionEl = document.getElementById('playlistDescription');
            if (playlist.description) {
                descriptionEl.textContent = playlist.description;
                descriptionEl.style.display = 'block';
            } else {
                descriptionEl.style.display = 'none';
            }
            
            const tagsContainer = document.getElementById('playlistTags');
            tagsContainer.innerHTML = '';
            if (playlist.tags && playlist.tags.length > 0) {
                playlist.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'playlist-tag';
                    tagEl.textContent = tag;
                    tagsContainer.appendChild(tagEl);
                });
            }
        }
        
        function clearPlaylistView() {
            document.getElementById('resultsTitle').innerHTML = '搜索结果';
            const tagIndicator = document.querySelector('.playlist-tag-indicator');
            if (tagIndicator) {
                tagIndicator.style.display = 'none';
            }
            document.getElementById('clearPlaylistBtn').style.display = 'none';
            
            document.getElementById('playlistDetail').style.display = 'none';
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <div>在上方搜索框输入关键词开始搜索音乐</div>
                </div>
            `;
            
            resultsContainer.classList.add('search-results-tall');
            
            currentPlaylist = [];
            currentIndex = -1;
            currentPlaylistId = null;
            
            setTimeout(() => {
                heightSyncInitialized = false;
                initHeightSync();
            }, 100);
        }
        
        function removePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            if (confirm(`确定要删除歌单 "${playlist.name}" 吗？`)) {
                savedPlaylists.splice(index, 1);
                localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                displaySavedPlaylists();
                showNotification('歌单已删除', 'success');
            }
        }
        
        async function updatePlaylist(index) {
            if (index < 0 || index >= savedPlaylists.length) return;
            
            const playlist = savedPlaylists[index];
            try {
                showNotification('正在更新歌单...', 'info');
                
                const response = await fetch(`${API_BASE}?types=playlist&source=netease&id=${playlist.id}`);
                const data = await response.json();
                
                if (data && data.code === 200 && data.playlist) {
                    const tracks = data.playlist.tracks.map(track => ({
                        id: track.id,
                        name: track.name,
                        artist: Array.isArray(track.ar) ? track.ar.map(a => a.name) : [track.ar.name],
                        album: track.al ? track.al.name : '',
                        picUrl: track.al ? track.al.picUrl : '',
                        lyric_id: track.id,
                        source: 'netease'
                    }));
                    
                    savedPlaylists[index].tracks = tracks;
                    savedPlaylists[index].name = data.playlist.name;
                    savedPlaylists[index].cover = data.playlist.coverImgUrl || '';
                    savedPlaylists[index].playCount = data.playlist.playCount || 0;
                    savedPlaylists[index].description = data.playlist.description || '';
                    savedPlaylists[index].tags = data.playlist.tags || [];
                    
                    localStorage.setItem('savedPlaylists', JSON.stringify(savedPlaylists));
                    
                    displaySavedPlaylists();
                    
                    let isCurrentPlaylist = false;
                    if (currentPlaylistId === playlist.id) {
                        isCurrentPlaylist = true;
                    }
                    
                    if (isCurrentPlaylist) {
                        currentPlaylist = tracks;
                        displaySearchResults(tracks);
                        displayPlaylistDetail(savedPlaylists[index]);
                        document.getElementById('resultsTitle').innerHTML = savedPlaylists[index].name;
                        
                        const resultsContainer = document.getElementById('searchResults');
                        resultsContainer.classList.remove('search-results-tall');
                    }
                    
                    showNotification('歌单更新完成', 'success');
                } else {
                    showNotification('无法获取歌单信息', 'error');
                }
            } catch (error) {
                console.error('更新歌单失败:', error);
                showNotification('更新歌单失败', 'error');
            }
        }
        
        function calculateOtherElementsHeight(playerSection, lyricsContainer) {
            let otherElementsHeight = 0;
            const playerChildren = playerSection.children;
            
            for (let i = 0; i < playerChildren.length; i++) {
                const child = playerChildren[i];
                if (child !== lyricsContainer) {
                    const computedStyle = window.getComputedStyle(child);
                    const marginTop = parseFloat(computedStyle.marginTop) || 0;
                    const marginBottom = parseFloat(computedStyle.marginBottom) || 0;
                    otherElementsHeight += child.offsetHeight + marginTop + marginBottom;
                }
            }
            
            const playerComputedStyle = window.getComputedStyle(playerSection);
            const playerPaddingTop = parseFloat(playerComputedStyle.paddingTop) || 0;
            const playerPaddingBottom = parseFloat(playerComputedStyle.paddingBottom) || 0;
            otherElementsHeight += playerPaddingTop + playerPaddingBottom;
            
            return otherElementsHeight;
        }
        
        function initHeightSync() {
            if (heightSyncInitialized) return;
            
            if (window.innerWidth <= 768) return;
            
            const contentSection = document.querySelector('.content-section');
            const playerSection = document.querySelector('.player-section');
            const lyricsContainer = document.getElementById('playerLyricsContainer');
            
            if (!contentSection || !playerSection || !lyricsContainer) return;
            
            initialContentHeight = contentSection.offsetHeight;
            initialPlayerHeight = playerSection.offsetHeight;
            
            const initialOtherElementsHeight = calculateOtherElementsHeight(playerSection, lyricsContainer);
            
            if (window.ResizeObserver) {
                contentResizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target === contentSection) {
                            const newContentHeight = entry.contentRect.height;
                            const contentHeightDiff = newContentHeight - initialContentHeight;
                            
                            const targetPlayerHeight = initialPlayerHeight + contentHeightDiff;
                            
                            const idealLyricsHeight = targetPlayerHeight - initialOtherElementsHeight;
                            
                            const newLyricsHeight = Math.max(initialLyricsHeight, idealLyricsHeight);
                            lyricsContainer.style.height = `${newLyricsHeight}px`;
                        }
                    }
                });
                
                contentResizeObserver.observe(contentSection);
                heightSyncInitialized = true;
            }
        }
        
        setVolume(80);
        displaySavedPlaylists();
        
        // --- Interactive Character ---
        const character = document.getElementById('character');
        const greetingBubble = document.getElementById('greeting-bubble');
        let synth;
        let isAudioInitialized = false;

        async function setupAudio() {
            if (isAudioInitialized) return;
            try {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                isAudioInitialized = true;
                console.log("Audio context started for character.");
            } catch (e) {
                console.error("Could not start audio context for character", e);
            }
        }

        function playSound() {
            if (!synth) return;
            synth.triggerAttackRelease("C5", "8n", Tone.now());
        }

        let isInteracting = false;

        function showGreeting(text) {
            greetingBubble.textContent = text;
            greetingBubble.classList.add('visible');
        }

        function hideGreeting() {
            greetingBubble.classList.remove('visible');
        }

        character.addEventListener('click', async () => {
            if (isInteracting) return;
            isInteracting = true;

            if (!isAudioInitialized) {
                await setupAudio();
            }
            playSound();

            character.classList.add('wave');
            showGreeting('Hi!');

            setTimeout(() => {
                character.classList.remove('wave');
                hideGreeting();
                isInteracting = false;
            }, 1500);
        });

        window.addEventListener('load', () => {
            // Music player load logic
            setTimeout(initHeightSync, 100);

            // Character greeting logic
            setTimeout(() => {
                showGreeting('Click me!');
                setTimeout(() => {
                    hideGreeting();
                }, 2000);
            }, 500);
        });
        
        window.addEventListener('resize', () => {
            heightSyncInitialized = false;
            setTimeout(initHeightSync, 100);
        });
    </script>
</body>
</html>
